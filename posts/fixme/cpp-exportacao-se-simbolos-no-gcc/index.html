<!DOCTYPE html>
<html lang="pt-br">

<head>

    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.0" />
<base href="https://geraldo.dev/">
<title>Exportação de símbolos no gcc | geraldo.dev</title>
<link rel="canonical" href="https://geraldo.dev/posts/fixme/cpp-exportacao-se-simbolos-no-gcc/">
<meta name="generator" content="Hugo 0.62.0" />


    <meta property="og:type" content="article" />
    <meta property="article:published_time" content="13/06/2018">



    <meta property="og:image" content="https://geraldo.dev/img/open_graph_02_1200x1200.jpg" />

    <meta property="og:description" content="Tecnologia, c&#43;&#43;, web, linux, git, desenvolvimento de software, dicas, tutoriais e notícias sobre o mundo opensource" />
    <meta property="og:url" content="https://geraldo.dev/posts/fixme/cpp-exportacao-se-simbolos-no-gcc/" />
    <meta property="og:site_name" content="geraldo.dev" />
    <meta property="og:title" content="Exportação de símbolos no gcc" />





    <meta name="description" content="Tecnologia, c&#43;&#43;, web, linux, git, desenvolvimento de software, dicas, tutoriais e notícias sobre o mundo opensource">
    
<meta name="author" content="Geraldo Ribeiro">

<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-139336679-1', 'auto');
	
	ga('send', 'pageview');
}
</script>



<link rel="stylesheet" async href="https://fonts.googleapis.com/icon?family=Material+Icons">
<link rel="stylesheet" async href="https://cdn.materialdesignicons.com/2.8.94/css/materialdesignicons.min.css">



<link rel="stylesheet"
      href="https://geraldo.dev/style.main.min.9e3ce174be768153dcf516f5eac5a7697a43da9708d5b1290103e0a7195c5a5c.css"
      integrity="sha256-njzhdL52gVPc9Rb16sWnaXpD2pcI1bEpAQPgpxlcWlw="
      media="screen" async>





</head>

<body>
    
        <header>
            <nav class="light-blue lighten-1" role="navigation">
    <div class="nav-wrapper container">
        <a id="logo-container" href="https://geraldo.dev/" class="brand-logo">geraldo.dev</a>


        <a href="#" data-target="mobile-demo" class="sidenav-trigger"><i class="material-icons">menu</i></a>
        <ul class="right hide-on-med-and-down">
            
<li><a href="/">Home</a></li>

<li><a href="/posts">Posts</a></li>

<li><a href="/publications">Artigos</a></li>

<li><a href="/projects">Projetos</a></li>


        </ul>
    </div>
</nav>

<ul class="sidenav" id="mobile-demo">
  
<li><a href="/">Home</a></li>

<li><a href="/posts">Posts</a></li>

<li><a href="/publications">Artigos</a></li>

<li><a href="/projects">Projetos</a></li>


</ul>


        </header>
    

    

    <main>
      <div class="page container">

        

        <div class="row">
          <div class="col s12 m6 center-align grey-text">
            Publicado em: 13/Jun/2018
          </div>
          
          <div class="col s12 m6 center-align grey-text">
            Atualizado em: 08/Jan/2020
          </div>
          
        </div>

        
        
        


        <h1>Exportação de símbolos no gcc</h1>

        
<aside class="table-of-contents">
  <header>
    <h3>Sumário</h3>
  </header>
  
</aside>




        <div class="gr-main-content">
        <p>FIXME
<a href="http://anadoxin.org/blog/control-over-symbol-exports-in-gcc.html">http://anadoxin.org/blog/control-over-symbol-exports-in-gcc.html</a></p>
<p>Control over symbol exports in GCC
written on Thu 30 October 2014</p>
<p>When dealing with creation of shared objects, one should keep in mind that the longer is the list of their exported symbols, the longer time is taken by the dynamic linker during the loading process.</p>
<p>There is much information regarding the rules which should be followed when one tries to create a shared object. There is a great paper written by the glibc maintainer, Ulrich Drepper, which covers most of the topics. You can find the paper on your favourite search engine (try searching for &ldquo;How to write shared libraries by Ulrich Drepper&rdquo;).</p>
<p>One of the important points is the restriction of exported symbols in a shared object. When creating an ELF shared object (by convention, a file named as lib*.so), all symbols are marked as public, hence included in the object's export symbol table. Obviously, existence of every symbol in the export table is not optimal. Export table should be populated only by the API of the shared object, because nobody every will (nobody ever should) use any of the internal structures, which the symbols are describing. Exported symbols are often considered as an Application Binary Interface (ABI), which should be compatible between different library versions. Maintaining the ABI of an internal structure effectively removes the possibility of any practical modification.</p>
<p>Normally, when you create a shared object on Linux, all of its symbols are exported by default. Consider this example:</p>
<p>#include <iostream>
using namespace std;</p>
<p>void function1() {
cout &laquo; &ldquo;hi\n&rdquo;;
}</p>
<p>void entry_point() {
function1();
}
The example shows a shared object that contains an API function (that is a function designed to be called from a different module, an entry point to the shared library's functionality). This entry_point API function uses a helper function, function1 to perform some task. Let's compile this shared object:</p>
<p>$ g++ code.cpp -o libcode.so -shared -fPIC
and let's glance at the export table:</p>
<p>$ nm -CD libcode.so | grep &quot; T &quot;
00000000000007c8 T entry_point()
00000000000007ac T function1()
0000000000000868 T _fini
0000000000000668 T _init
We have 4 symbols insite the text segment of libcode.so. _fini and _init are automalically added export symbols that relate to initialization and finalization of the object. Two other symbols are ours. Our goal is to make a shared library that will put entry_point in the export table, and at the same time leaving function1 from this table.</p>
<p>There are two methods for doing this: by using the -fvisibility option, and linker (ld) version script.</p>
<p>Using `fvisibility&rsquo; compiler option
The compiler flag -fvisibility=hidden is designed for dealing with exactly this kind of problems. By using this option, the user tells the compiler to exclude all of the symbols from the export table:</p>
<p>$ g++ code.cpp -o libcode.so -shared -fPIC -fvisibility=hidden
$ nm -CD libcode.so | grep &quot; T &quot;
00000000000007e8 T _fini
00000000000005f8 T _init
But, we want also to include the entry_point function in the table, because it's our API function. This is why we need to change the source code a little bit:</p>
<p>#include <iostream>
using namespace std;</p>
<p>void function1() {
cout &laquo; &ldquo;hi\n&rdquo;;
}</p>
<p><strong>attribute</strong> ((visibility (&ldquo;default&rdquo;))) void entry_point() {
function1();
}
After compilation, our goal is matched:</p>
<p>$ g++ code.cpp -o libcode.so -shared -fPIC -fvisibility=hidden
$ nm -CD libcode.so | grep &quot; T &quot;
0000000000000778 T entry_point()
0000000000000818 T _fini
0000000000000628 T _init
The <strong>attribute</strong> ((visibility (&ldquo;hidden&rdquo;))) is very similar to __declspec(dllexport) that can be found on Microsoft's compilers. In fact, GCC should handle it as well. The attribute overrides the -fvisibility=hidden compiler option only for only one symbol, and makes it public. That's why it's included in the export table.</p>
<p>Static library used by a shared library problems
However, there is one problem with this approach. If our shared library is large enough, it may use other libraries that are statically linked. Let's consider another example.</p>
<p>Let's suppose we have a static library, libutil.a, that is statically linked into our shared library, libcode.so.</p>
<p>Here is our util.cpp file, that is the source of the static library:</p>
<p>#include <iostream>
using namespace std;</p>
<p>void util_function() {
cout &laquo; &ldquo;hello from util function\n&rdquo;;
}
Let's compile it, and build a static library from this code:</p>
<p>$ g++ util.cpp -o util.o -c -fPIC
$ ar r libutil.a util.o
We have now libutil.a static library which can be used in our shared object. Let's modify the shared object to include a reference to the code of libutil.a (without it, libutil.a would be dropped in the linking process):</p>
<p>#include <iostream>
using namespace std;</p>
<p>extern void util_function();</p>
<p>void function1() {
util_function();
cout &laquo; &ldquo;hi\n&rdquo;;
}</p>
<p><strong>attribute</strong> ((visibility (&ldquo;default&rdquo;))) void entry_point() {
function1();
}
Let's compile our shared library and see its export table:</p>
<p>$ g++ code.cpp libutil.a -o libcode.so -shared -fPIC -fvisibility=hidden
$ nm -CD libcode.so | grep &quot; T &quot;
00000000000007ed T entry_point()
0000000000000858 T util_function()
0000000000000918 T _fini
0000000000000688 T _init
As you can see, util_function is included in the list, but we don't want it there. How to fix this?</p>
<p>One solution is to add -fvisibility=hidden to libutil.a library's build process, but sometimes we don't have the control over it. What then?</p>
<p>Linker scripts to the rescue.</p>
<p>Using `ld&rsquo; linker version script
We need to get rid of the util_function symbol during the linking process, because we may not have any control over the compilation of libutil.a library.</p>
<p>Fortunately, ld supports export table filtering (and much more) by using a &ldquo;version script&rdquo;, which will contain some definitions on what to include, and what to skip. It even supports wildcards which also may help.</p>
<p>So, let's skip the -fvisibility=hidden option for now, and build our shared library like this:</p>
<p>$ g++ code.cpp libutil.a -o libcode.so -shared -fPIC
Then, create a text file, libcode.version, with this content:</p>
<p>CODEABI_1.0 {
global: <em>entry_point</em>;
local: <em>;
};
This version file tells the linker, that all symbols (</em>) should be considered as local symbols (that is: hidden), and all symbols that match the wildcard <em>entry_point</em> should be considered as global (so, visible).</p>
<p>Compilation is done by the g++ driver:</p>
<p>$ g++ code.cpp libutil.a -o shared -fPIC -Wl,&ndash;version-script=libcode.version
Verification:</p>
<p>$ nm -CD libcode.so | grep &quot; T &quot;
000000000000074d T entry_point()
It even stripped out the _init and _fini symbols. Job done!</p>
<p>The problem with this approach is that it can't handle some more complicated scenarios, like filtering only some symbols that are using C++ templates. Some of the template-based symbols in C++ can easily grow up to few hundred characters, but you probably know what I mean. Once you start using functions from std::, you'll know.</p>
<p>Please do some reading about the linker's version scripts, because it allows you to perform some really cool things, like symbol versioning!</p>

        </div>

        

<div class="share-box center-align" aria-hidden="true">
  <ul class="share">
    <li>
      <a class="facebook"
        href="https://www.facebook.com/sharer.php?u=https%3a%2f%2fgeraldo.dev%2fposts%2ffixme%2fcpp-exportacao-se-simbolos-no-gcc%2f"
        aria-label="share on Facebook"
        target="_blank" rel="noopener">
        <span class="mdi mdi-48px mdi-facebook"></span>
      </a>
    </li>

    <li>
      <a class="twitter"
         href="https://twitter.com/intent/tweet?url=https%3a%2f%2fgeraldo.dev%2fposts%2ffixme%2fcpp-exportacao-se-simbolos-no-gcc%2f&amp;text=Exporta%c3%a7%c3%a3o%20de%20s%c3%admbolos%20no%20gcc"
         target="_blank" rel="noopener">
        <span class="mdi mdi-48px mdi-twitter"></span>
      </a>
    </li>

    <li>
      <a class="linkedin"
         href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fgeraldo.dev%2fposts%2ffixme%2fcpp-exportacao-se-simbolos-no-gcc%2f&amp;title=Exporta%c3%a7%c3%a3o%20de%20s%c3%admbolos%20no%20gcc"
         target="_blank" rel="noopener">
        <span class="mdi mdi-48px mdi-linkedin"></span>
      </a>
    </li>

    <li>
      <a class="email"
         href="mailto:?subject=Exporta%c3%a7%c3%a3o%20de%20s%c3%admbolos%20no%20gcc&amp;body=https%3a%2f%2fgeraldo.dev%2fposts%2ffixme%2fcpp-exportacao-se-simbolos-no-gcc%2f">
        <span class="mdi mdi-48px mdi-email"></span>
      </a>
    </li>

  </ul>
  <span>Compartilhe!</span>
</div>




        <div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "geraldo-dev" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
        <script>
var disqus_config = function () {
  this.language = "pt";
};
</script>

      </div>

    </main>


    
        <footer class="page-footer orange">
  <div class="container">
    <div class="row">
      <div class="col l9 s12">
        <h5 class="white-text">Você tem uma grande ideia?</h5>
        <p class="grey-text text-lighten-4">
          <ul>
            
          </ul>
        </p>

        <p class="grey-text text-lighten-4">
          Vamos marcar um café, talvez a solução seja muito mais simples do que você imagina.
        </p>
      </div>
      <div class="col l3 s12">
        <h5 class="white-text">Contatos</h5>
        <ul>
        
          <li>
            <a class="white-text" href="https://geraldo.dev">
              <span class="mdi mdi-24px mdi-web"></span>
              https://geraldo.dev
            </a>
          </li>
        
          <li>
            <a class="white-text" href="mailto:geraldolsribeiro@gmail.com">
              <span class="mdi mdi-24px mdi-email"></span>
              geraldo@intmain.io
            </a>
          </li>
        
          <li>
            <a class="white-text" href="https://api.whatsapp.com/send?phone=5512982302703&amp;text=Ol%c3%a1%20Geraldo!">
              <span class="mdi mdi-24px mdi-whatsapp"></span>
              (12) 9 8230 2703
            </a>
          </li>
        
          <li>
            <a class="white-text" href="https://twitter.com/geraldo_dev">
              <span class="mdi mdi-24px mdi-twitter"></span>
              geraldo_dev
            </a>
          </li>
        
          <li>
            <a class="white-text" href="https://www.instagram.com/geraldo.dev/">
              <span class="mdi mdi-24px mdi-instagram"></span>
              geraldo.dev
            </a>
          </li>
        
          <li>
            <a class="white-text" href="https://www.linkedin.com/in/geraldolsribeiro/">
              <span class="mdi mdi-24px mdi-linkedin"></span>
              geraldolsribeiro
            </a>
          </li>
        
          <li>
            <a class="white-text" href="https://www.facebook.com/geraldolsribeiro">
              <span class="mdi mdi-24px mdi-facebook"></span>
              geraldolsribeiro
            </a>
          </li>
        
          <li>
            <a class="white-text" href="https://github.com/geraldolsribeiro">
              <span class="mdi mdi-24px mdi-github-circle"></span>
              geraldolsribeiro
            </a>
          </li>
        
          <li>
            <a class="white-text" href="https://t.me/geraldolsribeiro">
              <span class="mdi mdi-24px mdi-telegram"></span>
              geraldolsribeiro
            </a>
          </li>
        
          <li>
            <a class="white-text" href="#ZgotmplZ">
              <span class="mdi mdi-24px mdi-skype"></span>
              geraldolsribeiro
            </a>
          </li>
        
          <li>
            <a class="white-text" href="https://codepen.io/geraldolsribeiro/">
              <span class="mdi mdi-24px mdi-codepen"></span>
              geraldolsribeiro
            </a>
          </li>
        
          <li>
            <a class="white-text" href="https://stackoverflow.com/users/554111/geraldo-luis-da-silva-ribeiro">
              <span class="mdi mdi-24px mdi-stack-overflow"></span>
              Stack overflow
            </a>
          </li>
        
          <li>
            <a class="white-text" href="https://scholar.google.com.br/citations?user=qsuG5ZkAAAAJ">
              <span class="mdi mdi-24px mdi-school"></span>
              Google Scholar
            </a>
          </li>
        
        </ul>
      </div>
    </div>
  </div>

    <div class="fixed-action-btn">
      <a class="btn-floating btn-large waves-effect waves-light ">
        <i class="large material-icons">chat</i>
      </a>
      <ul>
        
        
          <li>
              <a class="btn-floating waves-effect waves-light green darken-4"
                title="Chame pelo whatsapp!"
                target="_blank"
                href="https://api.whatsapp.com/send?phone=5512982302703&amp;text=Ol%c3%a1,%20Geraldo!">
              <span class="mdi mdi-24px mdi-whatsapp"></span>
            </a>
          </li>
        
      </ul>
    </div>


  <div class="footer-copyright">
    <div class="container">
      Feito com <i class="material-icons yellow-text" style="vertical-align: middle;">favorite</i> por Geraldo Ribeiro
    </div>
  </div>
</footer>

    

    
        






<script type="text/javascript" src="https://geraldo.dev/app.min.59882aba5a267177ea44b8e23767eb6092ffbd0fba04434f754edcc58be60ec5.js" integrity="sha256-WYgqulomcXfqRLjiN2frYJL/vQ&#43;6BENPdU7cxYvmDsU=" media="screen"></script>


    
</body>
</html>
