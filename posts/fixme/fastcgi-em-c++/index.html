<!DOCTYPE html>
<html lang="pt-br">

<head>

    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.0" />
<base href="https://geraldo.dev/">
<title>FastCGI em C&#43;&#43; | geraldo.dev</title>
<link rel="canonical" href="https://geraldo.dev/posts/fixme/fastcgi-em-c&#43;&#43;/">
<meta name="generator" content="Hugo 0.62.0" />


    <meta property="og:type" content="article" />
    <meta property="article:published_time" content="09/07/2018">



    <meta property="og:image" content="https://geraldo.dev/img/open_graph_02_1200x1200.jpg" />

    <meta property="og:description" content="Tecnologia, c&#43;&#43;, web, linux, git, desenvolvimento de software, dicas, tutoriais e notícias sobre o mundo opensource" />
    <meta property="og:url" content="https://geraldo.dev/posts/fixme/fastcgi-em-c&#43;&#43;/" />
    <meta property="og:site_name" content="geraldo.dev" />
    <meta property="og:title" content="FastCGI em C&#43;&#43;" />





    <meta name="description" content="Tecnologia, c&#43;&#43;, web, linux, git, desenvolvimento de software, dicas, tutoriais e notícias sobre o mundo opensource">
    
<meta name="author" content="Geraldo Ribeiro">

<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-139336679-1', 'auto');
	
	ga('send', 'pageview');
}
</script>



<link rel="stylesheet" async href="https://fonts.googleapis.com/icon?family=Material+Icons">
<link rel="stylesheet" async href="https://cdn.materialdesignicons.com/2.8.94/css/materialdesignicons.min.css">



<link rel="stylesheet"
      href="https://geraldo.dev/style.main.min.9e3ce174be768153dcf516f5eac5a7697a43da9708d5b1290103e0a7195c5a5c.css"
      integrity="sha256-njzhdL52gVPc9Rb16sWnaXpD2pcI1bEpAQPgpxlcWlw="
      media="screen" async>





</head>

<body>
    
        <header>
            <nav class="light-blue lighten-1" role="navigation">
    <div class="nav-wrapper container">
        <a id="logo-container" href="https://geraldo.dev/" class="brand-logo">geraldo.dev</a>


        <a href="#" data-target="mobile-demo" class="sidenav-trigger"><i class="material-icons">menu</i></a>
        <ul class="right hide-on-med-and-down">
            
<li><a href="/">Home</a></li>

<li><a href="/posts">Posts</a></li>

<li><a href="/publications">Artigos</a></li>

<li><a href="/projects">Projetos</a></li>


        </ul>
    </div>
</nav>

<ul class="sidenav" id="mobile-demo">
  
<li><a href="/">Home</a></li>

<li><a href="/posts">Posts</a></li>

<li><a href="/publications">Artigos</a></li>

<li><a href="/projects">Projetos</a></li>


</ul>


        </header>
    

    

    <main>
      <div class="page container">

        

        <div class="row">
          <div class="col s12 m6 center-align grey-text">
            Publicado em: 09/Jul/2018
          </div>
          
          <div class="col s12 m6 center-align grey-text">
            Atualizado em: 08/Jan/2020
          </div>
          
        </div>

        
        
        


        <h1>FastCGI em C&#43;&#43;</h1>

        
<aside class="table-of-contents">
  <header>
    <h3>Sumário</h3>
  </header>
  <ul>
    <li><a href="https://geraldo.dev/posts/fixme/fastcgi-em-c++/#porque-fastcgi-quando-j-tem-php-ruby-python-perl-etc">Porque FastCGI quando já tem PHP, Ruby, Python, Perl, etc?</a>
      <ul>
        <li><a href="https://geraldo.dev/posts/fixme/fastcgi-em-c++/#velocidade">Velocidade</a></li>
        <li><a href="https://geraldo.dev/posts/fixme/fastcgi-em-c++/#consumo-de-recursos">Consumo de recursos</a></li>
        <li><a href="https://geraldo.dev/posts/fixme/fastcgi-em-c++/#reuso-de-dados">Reuso de dados</a></li>
        <li><a href="https://geraldo.dev/posts/fixme/fastcgi-em-c++/#escalabilidade">Escalabilidade</a></li>
        <li><a href="https://geraldo.dev/posts/fixme/fastcgi-em-c++/#segurana">Segurança</a></li>
      </ul>
    </li>
    <li><a href="https://geraldo.dev/posts/fixme/fastcgi-em-c++/#qual-servidor-web-que-suporte-fastcgi-seria-uma-boa-escolha">Qual servidor web que suporte FastCGI seria uma boa escolha?</a></li>
    <li><a href="https://geraldo.dev/posts/fixme/fastcgi-em-c++/#quais-so-as-implementaes-do-protocol-fastcgi-disponveis">Quais são as implementações do protocol FastCGI disponíveis?</a></li>
    <li><a href="https://geraldo.dev/posts/fixme/fastcgi-em-c++/#o-que-so-sockets">O que são sockets?</a></li>
    <li><a href="https://geraldo.dev/posts/fixme/fastcgi-em-c++/#como-usar-a-biblioteca-libfcgi">Como usar a biblioteca libfcgi?</a></li>
    <li><a href="https://geraldo.dev/posts/fixme/fastcgi-em-c++/#exemplo-simples-de-aplicao-multi-threaded">Exemplo simples de aplicação multi-threaded</a></li>
    <li><a href="https://geraldo.dev/posts/fixme/fastcgi-em-c++/#exemplo-simples-de-configurao-do-nginx">Exemplo simples de configuração do Nginx</a></li>
    <li><a href="https://geraldo.dev/posts/fixme/fastcgi-em-c++/#referncias">Referências</a></li>
  </ul>

</aside>




        <div class="gr-main-content">
        <h2 id="porque-fastcgi-quando-j-tem-php-ruby-python-perl-etc">Porque FastCGI quando já tem PHP, Ruby, Python, Perl, etc?</h2>
<h3 id="velocidade">Velocidade</h3>
<p>Antes de tudo, a principal razão é que um programa compilado executa mais rapidamente que um interpretado. Para PHP, por exemplo, existem vários aceleradores (APC, eAccelerator, XCache) que reduzem o tempo de interpretação do código.
Isto simplesmente não é necessário para C/C++.</p>
<h3 id="consumo-de-recursos">Consumo de recursos</h3>
<p>Outro ponto que você deve se recordar é que tipagem dinâmica e garbage collector consomem muitos recurso, e algumas vezes recursos demais. Por exemplo, uma array de números inteiros em PHP ocupa aproximadamente 18 vezes mais espaço que em C++ (podendo chegar a 35 vezes dependendo da configuração do PHP). Isso pode resultar numa sobrecarga quando trabalhando com grandes estruturas de dados.</p>
<h3 id="reuso-de-dados">Reuso de dados</h3>
<p>Um programa FastCGI pode reaproveitar dados comuns entre diferentes requisições. Por exemplo, enquanto o PHP a cada requisição começa com uma folha em branco, o programa FastCGI pode fazer ações preparatórias antes da chegada da primeira requisição, tais como selecionar o storage, carregar alguns dados, etc. Obviamente, isso pode aumentar a performance do sistema.</p>
<h3 id="escalabilidade">Escalabilidade</h3>
<p>Para o <code>mod_php</code> assume-se que o servidor web (Apache) e o PHP estão na mesma máquina, enquanto aplicações FastCGI podem fazer uso de sockets TCP. Em outras palavras, você pode ter um cluster com várias máquinas se comunicando pela rede. FastCGI também suporta Unix domain sockets, o que permitem rodar a aplicação e o servidor web na mesma máquina de maneira mais efetiva.</p>
<h3 id="segurana">Segurança</h3>
<p>Pode ser que você não tenha percebido ainda, mas, por padrão, as configurações do Apache permitem coisas demais. Por exemplo, se uma pessoa mal intencionada carrega um script <code>exploit.php.jpg</code> como uma &ldquo;inocente imagem&rdquo;, o Apache vai executar o código PHP. É claro que você pode tomar a decisão de remove ou alterar as extensões potencialmente perigosas (php, php4, php5, phtml, etc).</p>
<p>Uma aplicação FastCGI pode ser executada num ambiente blindado (chroot), o que pode restringir fortemente os direitos de acesso da aplicação, deixando-a restrita ao diretório do chroot. Só permita o que realmente precisa ser, nada mais.</p>
<blockquote>
<p>Fifth — safety. You will not check, but with default settings of Apache allowed to fulfill all on light. For example, if the malefactor loaded on a site a tortious script exploit.php.jpg under the pretext of «an innocent picture» and then will open are more its in the browser, Apache will &ldquo;fairly&rdquo; fulfill the tortious php-code. Perhaps, single reliable enough decision — to delete or change all potentially dangerous extensions from names of load files, in this case — php, php4, php5, phtml, etc. Such reception are us, for example, in Drupal — to all &ldquo;additional&rdquo; extensions the underline character are add and it turned out exploit.php_.jpg. Truth it are necessary to mark that the system administrator could add any additional filename extension as the php handler so any.html could turn suddenly to an awful hole in safety only that.php looking ugly, were badly for SEO or it were not pleasant to the customer. So, what to us dayot in respect of safety of FastCGI? In the first if to use instead of Apache a Web server of Nginx it will simply give static files. Point. In other words, the file exploit.php.jpg will be g «as are», without any handling on server side so to launch a tortious script simply it will not turn out. In second, the FastCGI-program and a Web server could work from under different users so both the rights to files and folders at them will be different. For example, the Web server could read only the load files — for return of the static data of it enough, and the FastCGI-program could read and change only contents of a folder with load files — it enough for loading new and deleting of old files, but access immediately to the load files will not have so fulfill the malicious code too could not. In third, the FastCGI-program could work in chroot'е, distinct from chroot'а of a Web server. In itself chroot (change of a root directory) allowed to restrict strongly the rights of the program, that is to raise the common safety of system because the program could not simply get access to files outside of the specif directory.</p>
</blockquote>
<h2 id="qual-servidor-web-que-suporte-fastcgi-seria-uma-boa-escolha">Qual servidor web que suporte FastCGI seria uma boa escolha?</h2>
<p>Numa resposta curta: Eu uso Nginx. Existem muitos servidores com suporte
a FastCGI, incluindo comerciais. Algumas alternativa são:</p>
<ul>
<li>
<p><strong>Apache</strong>: este é o primeiro que me vem a mentes, consome muito mais recursos que o Nginx. Por exemplo, para manter 10.000 conexões inativas (HTTP keep-alive) é consumido aproximadamente 2,5M de armazenamento, o que é até uma máquina bem modesta da conta. Enquanto no Apache é criado um novo fluxo para cada nova conexão 10.000 fluxos é simplesmente uma fantasia.</p>
</li>
<li>
<p><strong>Lighttpd</strong>: a grande deficiência deste servidor web é que ele processa todos as requisições em um único fluxo.</p>
</li>
</ul>
<p>— a principal lack of this Web server that it processed all requests in an one flow. It meant that there could be problems with a mashtabiruyemost — you could not simply involve all 4-8 kernels of the modern processors. And second — if for any reason of podvisnet the flow of a Web server (for example because of the durable waiting of the answer from a hard disk), at you &ldquo;will hang up&rdquo; all server. In other words, all remaining clients will cease to receive answers because of one slow request.
One more candidate — Cherokee. On announcements of developers, more quickly Nginx and Lighttpd in some cases worked.</p>
<h2 id="quais-so-as-implementaes-do-protocol-fastcgi-disponveis">Quais são as implementações do protocol FastCGI disponíveis?</h2>
<p>No momento existem duas implementações do protocolo FastCGI: a biblioteca <code>libfcgi.lib</code> dos criadores do protocolo FastCGI e a <code>FastCGI++</code>.</p>
<p>A <code>libfcgi</code> foi desenvolvida em 1996 e sempre foi muito estável e é a que tem sido mais utilizada. Ela foi escrita em C com um wrapper para C++.</p>
<h2 id="o-que-so-sockets">O que são sockets?</h2>
<p>Resumidamente é um método de comunicação inter processos. Em todos os sistemas operacionais modernos cada processo tem seu próprio espaço de memória. Os sockets foram projetados para permitir que dois ou mais processos (programas), com diferentes espaços de memória, possam trocar informações. Existem tipos diferentes de socket, um para cada finalidade:</p>
<ul>
<li>TCP socket: usado numa rede para troca de informação entre computadores diferentes</li>
<li>Unix domain socket: usando para troca de informação dentro dos limites da própria máquina. Se parece com um arquivo de sistema, mas o hard disk não é realmente usado. Como não é necessário o uso da pilha de rede este tipo de socket é mais rápido (cerca de 10%) que o socket TCP.</li>
</ul>
<h2 id="como-usar-a-biblioteca-libfcgi">Como usar a biblioteca libfcgi?</h2>
<p>Então, digamos que queremos criar uma aplicação FastCGI multi threaded.
A primeira coisa que precisamos fazer é inicializar a biblioteca.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-cpp" data-lang="cpp"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">FCGX_Init</span>(<span style="color:#66d9ef">void</span>);
</code></pre></div><p>Atenção! Esta função deve ser chamada antes de todas as outras da biblioteca e somente uma vez (independente da quantidade de tráfego).</p>
<p>Na sequencia precisamos abrir um socket de escuta:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-cpp" data-lang="cpp"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">FCGX_OpenSocket</span>(<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>path, <span style="color:#66d9ef">int</span> backlog);
</code></pre></div><p>A variável <code>path</code> na linha acima determina o tipo de conexão. São suportados sockets Unix e TCP.</p>
<p>Exemplos de path para Unix domain socket:</p>
<pre><code>&quot;/tmp/fastcgi/mysocket&quot;
&quot;/tmp/fcgi_example.bare.sock&quot;
</code></pre><p>Acredito que esteja tudo claro aqui. Tudo que é necessário para transferir informações é um caminho único que todos os processos tenham acesso. Lembre-se que só funciona dentro da própria máquina.</p>
<p>Exemplos de path para sockets TCP:</p>
<pre><code>&quot;:5000&quot;
&quot;:9000&quot;
</code></pre><p>Neste caso o socket é aberto numa porta específica, e as requisições serão aceitas de qualquer IP.</p>
<p>Atenção! Este método é potencialmente inseguro, pois se o seu servidor está conectado a Internet aceitará requisições que qualquer outro computador.</p>
<p>Uma variação do path anterior, mas com funcionamento similar:</p>
<pre><code>&quot;*:5000&quot;
&quot;*:9000&quot;
</code></pre><p>Especifique explicitamente quais IPs podem enviar mensagens:</p>
<pre><code>&quot;5.5.5.5:5000&quot;
&quot;127.0.0.1:9000&quot;
</code></pre><p>Neste caso as conexões somente são aceitas de IP específicos, para todos os demais a porta estará fechada. Sim, é permitido criar uma conexão TCP para a mesma máquina, mas neste caso é preferível usar Unix domain socket se possível. Existem um caso onde, mesmo estando na mesma máquina não dá pra usar Unix domain socket: quando um dos programas está num cela chroot e não consegue acessar o arquivo do socket.</p>
<p>Infelizmente não é possível especificar dois IPs para aceitar conexão, e se este for o caso a porta deve estar totalmente aberta para todos os IPs, então filtre os IPs com firewall mesmo.</p>
<p>A biblioteca <code>libfcgi</code> não suporta IPv6.</p>
<p>Use preferencialmente, se possível, uma zona privada de IPs (<code>10.0.0.0/8</code>, <code>172.16.0.0/12</code>, <code>192.168.0.0/16</code>, <code>fc00::/7</code>, <code>127.0.0.0/8</code> and <code>::1/128</code>) para descartar pacotes vindos da Internet.</p>
<p>O último tipo de path é o de domínio:</p>
<pre><code>&quot;example.com:5000&quot;
&quot;localhost:9000&quot;
</code></pre><p>Neste caso o endereço IP será recebido automaticamente com base no nome de domínio que foi especificado. As restrições continuam as mesmas (só aceita IPv4). Considere que o socket é formado logo no início da operação da aplicação e  dinamicamente não é possível, sendo necessário reiniciar a aplicação.</p>
<p>O segundo parâmetro da função é o <code>backlog</code>, definido como o comprimento da fila de requisições. O valor especial 0 (zero) significa que será usado o valor padrão do sistema operacional. A cada vez que uma requisição chega do servidor Web, uma nova conexão é colocada na fila da aplicação. Se a fila está cheia todas as requisições posteriores serão terminadas com falha.</p>
<p>Então qual o comprimento ótimo para a fila? Geralmente, este parâmetro é melhor ajustado individualmente a partir dos dados do teste de carga, mas vamos tentar estimar uma faixa favorável para este valor. A primeira coisa que é necessário saber é que o comprimento máximo da fila é restrito pelo sistema operacional e normalmente não passa de 1024. Segundo, a fila consome recursos, mesmo como os hardwares poderosos de hoje não use mais que o estritamente necessário. Vamos supor que a aplicação utiliza 8 worker threads (tranquilo para um processador moderno de 4-8 núcleos), e que cada fluxo precise de sua própria conexão para que as tarefas sejam executadas em paralelo. Idealmente podemos tratar 8 requisições do servidor Web de cada vez sem nenhum atraso. Em outras palavras,o tamanho mínimo da fila de requisições é a quantidade de worker threads da aplicação. É possível aumentar este valor em 50% a 100% para prover algum armazenamento extra para carregamento.</p>
<p>Agora vamos definir o limite superior para a quantidade de requisições que podemos realmente processar. Se a fila for muito grande seus clientes simplesmente ficarão engarrafados aguardando alguma resposta.</p>
<p>Vamos supor que uma requisição possa ser respondida em 300 milissegundos. E sabendo que em média 50% dos visitantes irão abandonar se o tempo de carregamento da página for maior que 30 segundos. Está óbvio que 50% de insatisfeitos é muito, então vamos restringir o tempo máximo de carregamento da página para 5 segundos. Vamos assumir também que após a página ser carregada pelo navegador o tempo gasto para aplicar o CSS e executar os Javascripts consumiu 70% dos 5s. Então o tempo de carga fica limitado a 30% dos 5s, ou seja 1,5s. Vamos supor também que após o carregamento do HTML o browser inicie as requisições do demais recursos em paralelo e que o tempo de carga do HTML seja de 50% do tempo comum de aquisição de dados. Então aplicando 50% aos 1,5s temos o tempo teórico de 750ms para atender uma requisição. Se o tempo médio gasto é de 300ms então a fila para um do fluxo seria de 750ms/300ms, o que resulta em 2,5 requisições. Como temos 8 workers então deveríamos ter uma fila de 8*2,5, ou seja, 20 requisições. Embora este resultado esteja condicionado às suposições que fizemos serve como ponto de início para ajustes futuros.</p>
<p>Uma vez que recebemos um descritor de um socket é necessário armazená-lo em uma estrutura do seguinte tipo:</p>
<pre><code>typedef struct FCGX_Request {
    int requestId;
    int role;
    FCGX_Stream *in;
    FCGX_Stream *out;
    FCGX_Stream *err;
    char **envp;
    struct Params *paramsPtr;
    int ipcFd;
    int isBeginProcessed;
    int keepConnection;
    int appStatus;
    int nWriters;
    int flags;
    int listen_sock;
    int detached;
} FCGX_Request;
</code></pre><p>Atenção! Depois de obter uma nova requisição todos os dados anteriores são perdidos, portanto se necessário realize uma cópia dos dados e não somente dos ponteiros.</p>
<p>Você deve seguir esta estrutura:</p>
<ul>
<li>As variáveis <code>in</code>, <code>out</code> e <code>err</code> são os fluxo de entrada, saída e erro respectivamente.</li>
<li>O fluxo de entrada contem os dados da requisição POST.</li>
<li>No fluxo de saída é escrita a resposta do programa (por exemplo, os cabeçalhos HTTP e os código HTML da página)</li>
<li>O fluxo de erro é adicionado ao fluxo de erros do servidor web e não deve ser usado para log, use um arquivo separado se necessário</li>
<li>A variável <code>envp</code> contem os valores das variáveis do servidor web e cabeçalhos HTTP, por exemplo: <code>SERVER_PROTOCOL</code>, <code>REQUEST_METHOD</code>, <code>REQUEST_URI</code>, <code>QUERY_STRING</code>, <code>CONTENT_LENGTH</code>, <code>HTTP_USER_AGENT</code>, <code>HTTP_COOKIE</code>, <code>HTTP_REFERER</code> entre outras. Este nomes estão definidos no padrão dos protocolos CGI e HTTP. Os dados estão armazenados em arrays de linhas, na qual a última célula contem um ponteiro nulo (NULL) como marcador de fim. Todas as linhas (cada array de células de linhas) contem uma variável no formato <code>CHAVE=VALOR</code>, por exemplo: <code>CONTENT_LENGTH=0</code> (neste caso significa que a requisição não contem dados). Se uma array de linhas do <code>envp</code> não contem o título necessário para você, significar que ainda não foi transferido. Se você precisa receber todos os valores de variáveis transferidos para o programa simplesmente leia em loop até encontrar o ponteiro nulo.</li>
</ul>
<p>Vamos finalizar a descrição da estrutura, os valores restantes não serão necessários para o entendimento neste momento.</p>
<p>Agora é necessário inicializar (preencher) a estrutura da requisição:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-cpp" data-lang="cpp"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">FCGX_InitRequest</span>(FCGX_Request <span style="color:#f92672">*</span>request, <span style="color:#66d9ef">int</span> sock, <span style="color:#66d9ef">int</span> flags);
</code></pre></div><p>Os parâmetros são os seguintes:</p>
<ul>
<li><code>request</code>: o ponteiro para a estrutura a ser inicializada</li>
<li><code>sock</code>: um descritor de socket (aquele recebido depois da execução da função <code>FCGX_OpenSocket</code>)</li>
<li><code>flags</code>: só tem um flag atualmente <code>FCGI_FAIL_ACCEPT_ON_INTR</code> para não causar ruptura da <code>FCGX_Accept_r</code>.</li>
</ul>
<p>Após e necessário receber a nova requisição:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-cpp" data-lang="cpp"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">FCGX_Accept_r</span>(FCGX_Request <span style="color:#f92672">*</span>request);
</code></pre></div><p>É necessário transferir a estrutura da requisição que já foi inicializada para o último estágio.</p>
<p>Atenção! Em programas multi threaded é necessário sincronização através de chamada a função g.</p>
<p>Atualmente, esta função realiza todas as operações com sockets: primeiro ela envia a resposta para o servidor web na requisição anterior (se houver), fecha o link de dados anterior e libera todos os recursos conectados com eles (incluindo a variável de estrutura de requisição), então recebe a nova requisição, abre um novo link de dados e prepara o novo dado na estrutura da requisição subsequente. Em caso de um erro na obtenção da nova requisição a função retorna um código de erro.</p>
<p>Para ler as variáveis recebidas é possível processar independentemente a array <code>request-&gt;envp</code>, ou usar a função:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-cpp" data-lang="cpp"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">FCGX_GetParam</span>(<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>name, FCGX_ParamArray envp);
</code></pre></div><p>Onde <code>name</code> é uma linha contendo o título da variável ou um cabeçalho HTTP e <code>envp</code> é a array de variáveis. Esta função retorna o valor da variável como uma linha de texto. Cuidado para não confundir com <code>char ** FCGX_ParamArray</code>.</p>
<p>Após realizado o processamento, é necessário enviar a resposta ao servidor web. Use o fluxo de saída <code>request-&gt;out</code> para este propósito, junto com a função:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-cpp" data-lang="cpp"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">FCGX_PutStr</span>(<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>str, <span style="color:#66d9ef">int</span> n, FCGX_Stream <span style="color:#f92672">*</span>stream);
</code></pre></div><p>Onde <code>str</code> é um buffer contendo o dado de saída, o qual pode ser binário, <code>n</code> é o tamanho do buffer em bytes, <code>stream</code> é o fluxo no qual será escrito (<code>request-&gt;out</code> ou <code>request-&gt;err</code>).</p>
<p>Se você utilizou linhas ao estilo C (com final nulo), será mais conveniente usar a função:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-cpp" data-lang="cpp"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">FCGX_PutS</span>(<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>str, FCGX_Stream <span style="color:#f92672">*</span>stream);
</code></pre></div><p>A qual simplesmente definirá o tamanho da linha usando a função <code>strlen(str)</code> e chamará a função anterior. Se estiver usando <code>std::string</code> use a função anterior.</p>
<p>Esta funções trabalham perfeitamente com UTF-8.</p>
<p>Você pode usar esta função algumas vezes durante o tratamento de uma mesma requisição, em alguns casos para aumentar a produtividade. Por exemplo, digamos que você precise enviar um arquivo grande. Em vez de carregar o arquivo todo do disco rígido, e então enviá-lo em um única peça, você poderia iniciar o envio de dos dados antes. Como resultado o cliente que antes teria um tela em branco começa a obter o dado e mantem o interesse, é um efeito puramente psicológico que força o cliente a aguardar mais um pouco. Em outras palavras, você pode gastar um pouco mais de tempo carregando a página. É desejável que o CSS e os scripts estejam no começo da página, assim o browser pode ir analisando parte do código HTML e começar o carregamento dos recursos mais cedo.</p>
<p>A seguinte função é útil para processar requisições POST.</p>
<pre><code>int FCGX_GetStr(char * str, int n, FCGX_Stream *stream);
</code></pre><p>onde <code>str</code> é o ponteiro para o buffer, <code>n</code> é o tamanho do buffer em bytes, <code>stream</code> é o fluxo de onde estamos lendo os dados.</p>
<p>O tamanho do dado a ser transmitido na requisição POST (em bytes) pode ser obtido da variável <code>CONTENT_LENGHT</code> a qual pode ser obtida pela função <code>FCGX_GetParam</code> vista anteriormente.</p>
<p>Atenção! Criar o buffer com base no tamanho obtido do valor de <code>CONTENT_LENGTH</code> pode não ser uma boa alternativa, pois um atacante poderia enviar um POST gigante, o que faria consumir todos os recursos do seu servidor (típico ataque DoS) e fazê-lo parar de responder. Em vez disso defina o tamanho do buffer para algo razoável (de vários kilobytes a poucos megabytes) e chame a função <code>FCGX_GetStr</code> várias vezes.</p>
<p>A última função importante irá esvaziar os fluxos e saída e erros (enviar os dados ainda não enviados) e fechar a conexão.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-cpp" data-lang="cpp"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">FCGX_Finish_r</span>(FCGX_Request <span style="color:#f92672">*</span>request);
</code></pre></div><p>Esta função não é obrigatória, pois a função <code>FCGX_Accept_r</code> irá enviar os dados para o cliente e fechar a conexão atual antes de obter uma nova requisição. Então para que é necessária esta função? Se você já enviou todos os dados necessários ao cliente (o browser), mas ainda tem algumas operações para fazer tais como escrever estatísticas na base de dados, erros no arquivos, etc. É óbvio que a conexão com o cliente não é mais necessária então ao fechar a requisição faz com que o cliente receba os dados antes, embora o tempo para tratar a requisição não seja alterado.</p>
<h2 id="exemplo-simples-de-aplicao-multi-threaded">Exemplo simples de aplicação multi-threaded</h2>
<p>Para tentar deixar tudo mais claro ai vai um exemplo.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-cpp" data-lang="cpp"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  1</span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;pthread.h&gt;</span><span style="color:#75715e">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  2</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;sys/types.h&gt;</span><span style="color:#75715e">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  3</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;stdio.h&gt;</span><span style="color:#75715e">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  4</span><span style="color:#75715e"></span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  5</span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&#34;fcgi_config.h&#34;</span><span style="color:#75715e">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  6</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&#34;fcgiapp.h&#34;</span><span style="color:#75715e">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  7</span><span style="color:#75715e"></span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  8</span><span style="color:#75715e">#</span><span style="color:#75715e">define THREAD_COUNT 8</span><span style="color:#75715e">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  9</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">define SOCKET_PATH &#34;127.0.0.1:9000&#34;</span><span style="color:#75715e">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 10</span><span style="color:#75715e"></span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 11</span><span style="color:#75715e">//хранит дескриптор открытого сокета
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 12</span><span style="color:#75715e"></span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">int</span> socketId;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 13</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 14</span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">doit</span>(<span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>a)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 15</span>{
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 16</span>    <span style="color:#66d9ef">int</span> rc, i;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 17</span>    FCGX_Request request;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 18</span>    <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>server_name;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 19</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 20</span>    <span style="color:#66d9ef">if</span>(FCGX_InitRequest(<span style="color:#f92672">&amp;</span>request;, socketId, <span style="color:#ae81ff">0</span>) <span style="color:#f92672">!</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 21</span>    {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 22</span>        <span style="color:#75715e">//ошибка при инициализации структуры запроса
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 23</span><span style="color:#75715e"></span>        printf(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Can not init request</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 24</span>        <span style="color:#66d9ef">return</span> NULL;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 25</span>    }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 26</span>    printf(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Request is inited</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 27</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 28</span>    <span style="color:#66d9ef">for</span>(;;)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 29</span>    {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 30</span>        <span style="color:#66d9ef">static</span> pthread_mutex_t accept_mutex <span style="color:#f92672">=</span> PTHREAD_MUTEX_INITIALIZER;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 31</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 32</span>        <span style="color:#75715e">//попробовать получить новый запрос
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 33</span><span style="color:#75715e"></span>        printf(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Try to accept new request</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 34</span>        pthread_mutex_lock(<span style="color:#f92672">&amp;</span>accept;_mutex);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 35</span>        rc <span style="color:#f92672">=</span> FCGX_Accept_r(<span style="color:#f92672">&amp;</span>request;);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 36</span>        pthread_mutex_unlock(<span style="color:#f92672">&amp;</span>accept;_mutex);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 37</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 38</span>        <span style="color:#66d9ef">if</span>(rc <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span>)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 39</span>        {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 40</span>            <span style="color:#75715e">//ошибка при получении запроса
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 41</span><span style="color:#75715e"></span>            printf(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Can not accept new request</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 42</span>            <span style="color:#66d9ef">break</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 43</span>        }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 44</span>        printf(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">request is accepted</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 45</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 46</span>        <span style="color:#75715e">//получить значение переменной
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 47</span><span style="color:#75715e"></span>        server_name <span style="color:#f92672">=</span> FCGX_GetParam(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">SERVER_NAME</span><span style="color:#e6db74">&#34;</span>, request.envp);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 48</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 49</span>        <span style="color:#75715e">//вывести все HTTP-заголовки (каждый заголовок с новой строки)
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 50</span><span style="color:#75715e"></span>        FCGX_PutS(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Content-type: text/html</span><span style="color:#ae81ff">\r</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, request.out);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 51</span>        <span style="color:#75715e">//между заголовками и телом ответа нужно вывести пустую строку
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 52</span><span style="color:#75715e"></span>        FCGX_PutS(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\r</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, request.out);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 53</span>        <span style="color:#75715e">//вывести тело ответа (например - html-код веб-страницы)
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 54</span><span style="color:#75715e"></span>        FCGX_PutS(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">&lt;html&gt;</span><span style="color:#ae81ff">\r</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, request.out);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 55</span>        FCGX_PutS(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">&lt;head&gt;</span><span style="color:#ae81ff">\r</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, request.out);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 56</span>        FCGX_PutS(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">&lt;title&gt;FastCGI Hello! (multi-threaded C, fcgiapp library)&lt;/title&gt;</span><span style="color:#ae81ff">\r</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, request.out);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 57</span>        FCGX_PutS(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">&lt;/head&gt;</span><span style="color:#ae81ff">\r</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, request.out);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 58</span>        FCGX_PutS(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">&lt;body&gt;</span><span style="color:#ae81ff">\r</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, request.out);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 59</span>        FCGX_PutS(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">&lt;h1&gt;FastCGI Hello! (multi-threaded C, fcgiapp library)&lt;/h1&gt;</span><span style="color:#ae81ff">\r</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, request.out);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 60</span>        FCGX_PutS(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">&lt;p&gt;Request accepted from host &lt;i&gt;</span><span style="color:#e6db74">&#34;</span>, request.out);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 61</span>        FCGX_PutS(server_name <span style="color:#f92672">?</span> server_name : <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">?</span><span style="color:#e6db74">&#34;</span>, request.out);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 62</span>        FCGX_PutS(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">&lt;/i&gt;&lt;/p&gt;</span><span style="color:#ae81ff">\r</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, request.out);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 63</span>        FCGX_PutS(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">&lt;/body&gt;</span><span style="color:#ae81ff">\r</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, request.out);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 64</span>        FCGX_PutS(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">&lt;/html&gt;</span><span style="color:#ae81ff">\r</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, request.out);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 65</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 66</span>        <span style="color:#75715e">//&#34;заснуть&#34; - имитация многопоточной среды
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 67</span><span style="color:#75715e"></span>        sleep(<span style="color:#ae81ff">2</span>);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 68</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 69</span>        <span style="color:#75715e">//закрыть текущее соединение
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 70</span><span style="color:#75715e"></span>        FCGX_Finish_r(<span style="color:#f92672">&amp;</span>request;);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 71</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 72</span>        <span style="color:#75715e">//завершающие действия - запись статистики, логгирование ошибок и т.п.
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 73</span><span style="color:#75715e"></span>    }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 74</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 75</span>    <span style="color:#66d9ef">return</span> NULL;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 76</span>}
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 77</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 78</span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>(<span style="color:#66d9ef">void</span>)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 79</span>{
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 80</span>    <span style="color:#66d9ef">int</span> i;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 81</span>    pthread_t id[THREAD_COUNT];
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 82</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 83</span>    <span style="color:#75715e">//инициализация библилиотеки
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 84</span><span style="color:#75715e"></span>    FCGX_Init();
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 85</span>    printf(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Lib is inited</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 86</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 87</span>    <span style="color:#75715e">//открываем новый сокет
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 88</span><span style="color:#75715e"></span>    socketId <span style="color:#f92672">=</span> FCGX_OpenSocket(SOCKET_PATH, <span style="color:#ae81ff">20</span>);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 89</span>    <span style="color:#66d9ef">if</span>(socketId <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span>)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 90</span>    {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 91</span>      <span style="color:#75715e">//ошибка при открытии сокета
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 92</span><span style="color:#75715e"></span>      <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">1</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 93</span>    }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 94</span>    printf(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Socket is opened</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 95</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 96</span>    <span style="color:#75715e">//создаём рабочие потоки
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 97</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">for</span>(i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> THREAD_COUNT; i<span style="color:#f92672">+</span><span style="color:#f92672">+</span>)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 98</span>    {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 99</span>        pthread_create(<span style="color:#f92672">&amp;</span>id;[i], NULL, doit, NULL);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">100</span>    }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">101</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">102</span>    <span style="color:#75715e">//ждем завершения рабочих потоков
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">103</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">for</span>(i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> THREAD_COUNT; i<span style="color:#f92672">+</span><span style="color:#f92672">+</span>)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">104</span>    {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">105</span>        pthread_join(id[i], NULL);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">106</span>    }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">107</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">108</span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">109</span>}
</code></pre></div><h2 id="exemplo-simples-de-configurao-do-nginx">Exemplo simples de configuração do Nginx</h2>
<p>Um exemplo elementar se parece com:</p>
<pre><code>server {
  server_name localhost;
<p>location / {
fastcgi_pass 127.0.0.1:9000;
#fastcgi_pass  unix:/tmp/fastcgi/mysocket;
#fastcgi_pass localhost:9000;</p>
<pre><code>include fastcgi_params;
</code></pre>
<p>}
}
</code></pre><p>Isto já é uma configuração suficiente para execução correta de um programa FastCGI.
As linhas comentadas são para usar Unix socket domain e nome de domínio no lugar do IP.</p></p>
<h2 id="referncias">Referências</h2>
<ul>
<li><a href="http://developers-club.com/posts/154187/">The web application on a C/C ++ by means of FastCGI — it are simple</a></li>
<li><a href="habrahabr.ru/post/154187/">Artigo original</a></li>
</ul>

        </div>

        

<div class="share-box center-align" aria-hidden="true">
  <ul class="share">
    <li>
      <a class="facebook"
        href="https://www.facebook.com/sharer.php?u=https%3a%2f%2fgeraldo.dev%2fposts%2ffixme%2ffastcgi-em-c%2b%2b%2f"
        aria-label="share on Facebook"
        target="_blank" rel="noopener">
        <span class="mdi mdi-48px mdi-facebook"></span>
      </a>
    </li>

    <li>
      <a class="twitter"
         href="https://twitter.com/intent/tweet?url=https%3a%2f%2fgeraldo.dev%2fposts%2ffixme%2ffastcgi-em-c%2b%2b%2f&amp;text=FastCGI%20em%20C%2b%2b"
         target="_blank" rel="noopener">
        <span class="mdi mdi-48px mdi-twitter"></span>
      </a>
    </li>

    <li>
      <a class="linkedin"
         href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fgeraldo.dev%2fposts%2ffixme%2ffastcgi-em-c%2b%2b%2f&amp;title=FastCGI%20em%20C%2b%2b"
         target="_blank" rel="noopener">
        <span class="mdi mdi-48px mdi-linkedin"></span>
      </a>
    </li>

    <li>
      <a class="email"
         href="mailto:?subject=FastCGI%20em%20C%2b%2b&amp;body=https%3a%2f%2fgeraldo.dev%2fposts%2ffixme%2ffastcgi-em-c%2b%2b%2f">
        <span class="mdi mdi-48px mdi-email"></span>
      </a>
    </li>

  </ul>
  <span>Compartilhe!</span>
</div>




        <div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "geraldo-dev" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
        <script>
var disqus_config = function () {
  this.language = "pt";
};
</script>

      </div>

    </main>


    
        <footer class="page-footer orange">
  <div class="container">
    <div class="row">
      <div class="col l9 s12">
        <h5 class="white-text">Você tem uma grande ideia?</h5>
        <p class="grey-text text-lighten-4">
          <ul>
            
          </ul>
        </p>

        <p class="grey-text text-lighten-4">
          Vamos marcar um café, talvez a solução seja muito mais simples do que você imagina.
        </p>
      </div>
      <div class="col l3 s12">
        <h5 class="white-text">Contatos</h5>
        <ul>
        
          <li>
            <a class="white-text" href="https://geraldo.dev">
              <span class="mdi mdi-24px mdi-web"></span>
              https://geraldo.dev
            </a>
          </li>
        
          <li>
            <a class="white-text" href="mailto:geraldolsribeiro@gmail.com">
              <span class="mdi mdi-24px mdi-email"></span>
              geraldo@intmain.io
            </a>
          </li>
        
          <li>
            <a class="white-text" href="https://api.whatsapp.com/send?phone=5512982302703&amp;text=Ol%c3%a1%20Geraldo!">
              <span class="mdi mdi-24px mdi-whatsapp"></span>
              (12) 9 8230 2703
            </a>
          </li>
        
          <li>
            <a class="white-text" href="https://twitter.com/geraldo_dev">
              <span class="mdi mdi-24px mdi-twitter"></span>
              geraldo_dev
            </a>
          </li>
        
          <li>
            <a class="white-text" href="https://www.instagram.com/geraldo.dev/">
              <span class="mdi mdi-24px mdi-instagram"></span>
              geraldo.dev
            </a>
          </li>
        
          <li>
            <a class="white-text" href="https://www.linkedin.com/in/geraldolsribeiro/">
              <span class="mdi mdi-24px mdi-linkedin"></span>
              geraldolsribeiro
            </a>
          </li>
        
          <li>
            <a class="white-text" href="https://www.facebook.com/geraldolsribeiro">
              <span class="mdi mdi-24px mdi-facebook"></span>
              geraldolsribeiro
            </a>
          </li>
        
          <li>
            <a class="white-text" href="https://github.com/geraldolsribeiro">
              <span class="mdi mdi-24px mdi-github-circle"></span>
              geraldolsribeiro
            </a>
          </li>
        
          <li>
            <a class="white-text" href="https://t.me/geraldolsribeiro">
              <span class="mdi mdi-24px mdi-telegram"></span>
              geraldolsribeiro
            </a>
          </li>
        
          <li>
            <a class="white-text" href="#ZgotmplZ">
              <span class="mdi mdi-24px mdi-skype"></span>
              geraldolsribeiro
            </a>
          </li>
        
          <li>
            <a class="white-text" href="https://codepen.io/geraldolsribeiro/">
              <span class="mdi mdi-24px mdi-codepen"></span>
              geraldolsribeiro
            </a>
          </li>
        
          <li>
            <a class="white-text" href="https://stackoverflow.com/users/554111/geraldo-luis-da-silva-ribeiro">
              <span class="mdi mdi-24px mdi-stack-overflow"></span>
              Stack overflow
            </a>
          </li>
        
          <li>
            <a class="white-text" href="https://scholar.google.com.br/citations?user=qsuG5ZkAAAAJ">
              <span class="mdi mdi-24px mdi-school"></span>
              Google Scholar
            </a>
          </li>
        
        </ul>
      </div>
    </div>
  </div>

    <div class="fixed-action-btn">
      <a class="btn-floating btn-large waves-effect waves-light ">
        <i class="large material-icons">chat</i>
      </a>
      <ul>
        
        
          <li>
              <a class="btn-floating waves-effect waves-light green darken-4"
                title="Chame pelo whatsapp!"
                target="_blank"
                href="https://api.whatsapp.com/send?phone=5512982302703&amp;text=Ol%c3%a1,%20Geraldo!">
              <span class="mdi mdi-24px mdi-whatsapp"></span>
            </a>
          </li>
        
      </ul>
    </div>


  <div class="footer-copyright">
    <div class="container">
      Feito com <i class="material-icons yellow-text" style="vertical-align: middle;">favorite</i> por Geraldo Ribeiro
    </div>
  </div>
</footer>

    

    
        






<script type="text/javascript" src="https://geraldo.dev/app.min.59882aba5a267177ea44b8e23767eb6092ffbd0fba04434f754edcc58be60ec5.js" integrity="sha256-WYgqulomcXfqRLjiN2frYJL/vQ&#43;6BENPdU7cxYvmDsU=" media="screen"></script>


    
</body>
</html>
