<!DOCTYPE html>
<html lang="pt-br">

<head>

    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.0" />
<base href="https://geraldo.dev/">
<title>Virtual Hosts on nginx (CSC309) | geraldo.dev</title>
<link rel="canonical" href="https://geraldo.dev/posts/fixme/nginx-proxy/">
<meta name="generator" content="Hugo 0.62.0" />


    <meta property="og:type" content="article" />
    <meta property="article:published_time" content="06/09/2018">



    <meta property="og:image" content="https://geraldo.dev/img/open_graph_02_1200x1200.jpg" />

    <meta property="og:description" content="Tecnologia, c&#43;&#43;, web, linux, git, desenvolvimento de software, dicas, tutoriais e notícias sobre o mundo opensource" />
    <meta property="og:url" content="https://geraldo.dev/posts/fixme/nginx-proxy/" />
    <meta property="og:site_name" content="geraldo.dev" />
    <meta property="og:title" content="Virtual Hosts on nginx (CSC309)" />





    <meta name="description" content="Tecnologia, c&#43;&#43;, web, linux, git, desenvolvimento de software, dicas, tutoriais e notícias sobre o mundo opensource">
    
<meta name="author" content="Geraldo Ribeiro">

<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-139336679-1', 'auto');
	
	ga('send', 'pageview');
}
</script>



<link rel="stylesheet" async href="https://fonts.googleapis.com/icon?family=Material+Icons">
<link rel="stylesheet" async href="https://cdn.materialdesignicons.com/2.8.94/css/materialdesignicons.min.css">



<link rel="stylesheet"
      href="https://geraldo.dev/style.main.min.9e3ce174be768153dcf516f5eac5a7697a43da9708d5b1290103e0a7195c5a5c.css"
      integrity="sha256-njzhdL52gVPc9Rb16sWnaXpD2pcI1bEpAQPgpxlcWlw="
      media="screen" async>





</head>

<body>
    
        <header>
            <nav class="light-blue lighten-1" role="navigation">
    <div class="nav-wrapper container">
        <a id="logo-container" href="https://geraldo.dev/" class="brand-logo">geraldo.dev</a>


        <a href="#" data-target="mobile-demo" class="sidenav-trigger"><i class="material-icons">menu</i></a>
        <ul class="right hide-on-med-and-down">
            
<li><a href="/">Home</a></li>

<li><a href="/posts">Posts</a></li>

<li><a href="/publications">Artigos</a></li>

<li><a href="/projects">Projetos</a></li>


        </ul>
    </div>
</nav>

<ul class="sidenav" id="mobile-demo">
  
<li><a href="/">Home</a></li>

<li><a href="/posts">Posts</a></li>

<li><a href="/publications">Artigos</a></li>

<li><a href="/projects">Projetos</a></li>


</ul>


        </header>
    

    

    <main>
      <div class="page container">

        

        <div class="row">
          <div class="col s12 m6 center-align grey-text">
            Publicado em: 06/Sep/2018
          </div>
          
          <div class="col s12 m6 center-align grey-text">
            Atualizado em: 08/Jan/2020
          </div>
          
        </div>

        
        
        


        <h1>Virtual Hosts on nginx (CSC309)</h1>

        
<aside class="table-of-contents">
  <header>
    <h3>Sumário</h3>
  </header>
  <ul>
    <li><a href="https://geraldo.dev/posts/fixme/nginx-proxy/#install-nginx">Install nginx</a>
      <ul>
        <li><a href="https://geraldo.dev/posts/fixme/nginx-proxy/#cdf-uoft">CDF @UofT</a></li>
        <li><a href="https://geraldo.dev/posts/fixme/nginx-proxy/#ubuntu">Ubuntu</a></li>
        <li><a href="https://geraldo.dev/posts/fixme/nginx-proxy/#mac-os">Mac OS</a></li>
      </ul>
    </li>
    <li><a href="https://geraldo.dev/posts/fixme/nginx-proxy/#configuration">Configuration</a>
      <ul>
        <li><a href="https://geraldo.dev/posts/fixme/nginx-proxy/#step-1----booting-servers-for-virtual-hosts">Step 1 &ndash; Booting Servers for Virtual Hosts</a></li>
        <li><a href="https://geraldo.dev/posts/fixme/nginx-proxy/#step-2----configure-nginxs-port">Step 2 &ndash; Configure nginx's Port</a></li>
        <li><a href="https://geraldo.dev/posts/fixme/nginx-proxy/#step-3----configure-">Step 3 &ndash; Configure /</a></li>
        <li><a href="https://geraldo.dev/posts/fixme/nginx-proxy/#step-4----reload-nginxs-configuration">Step 4 &ndash; Reload nginx's Configuration</a></li>
        <li><a href="https://geraldo.dev/posts/fixme/nginx-proxy/#step-5----add-blog-and-mail">Step 5 &ndash; Add /blog and /mail</a></li>
        <li><a href="https://geraldo.dev/posts/fixme/nginx-proxy/#step-6----reload-your-nginx-configuration">Step 6 &ndash; Reload Your nginx Configuration</a></li>
        <li><a href="https://geraldo.dev/posts/fixme/nginx-proxy/#step-7----rewriting-requests">Step 7 &ndash; Rewriting Requests</a></li>
        <li><a href="https://geraldo.dev/posts/fixme/nginx-proxy/#step-8----reload-and-test">Step 8 &ndash; Reload and Test.</a></li>
        <li><a href="https://geraldo.dev/posts/fixme/nginx-proxy/#exercise-1">Exercise 1</a></li>
        <li><a href="https://geraldo.dev/posts/fixme/nginx-proxy/#step-9-optional----redirecting-based-on-host-name">Step 9 (optional) &ndash; Redirecting Based on Host Name</a></li>
      </ul>
    </li>
  </ul>

</aside>




        <div class="gr-main-content">
        <p>When hosting our web applications, we often have one public IP
address (<em>i.e.,</em> an IP address visible to the outside world)
using which we want to host multiple web apps. For example, one
may wants to host three different web apps respectively for
<code>example1.com</code>, <code>example2.com</code>, and <code>example1.com/images</code> on
the same machine using a single IP address.</p>
<p><strong>How can we do that?</strong> Well, the good news is Internet browsers
send the domain name inside HTTP requests and all we need to do
is to parse the requested domain name and URL and then route the
HTTP request to the actual web server.</p>
<p><strong>Oh, do I really need to parse HTTP requests?</strong> You can if you
really want to, but there are lots of tools and technologies that
readily do this for you. In this tutorial, we walk you through
how you can use nginx to <em>proxy</em> multiple web applications.</p>
<h2 id="install-nginx">Install nginx</h2>
<h3 id="cdf-uoft">CDF @UofT</h3>
<p>We have prepared pre-copmiled binaries for your.
You need to download <a href="http://www.cs.toronto.edu/~soheil/csc309/nginx.tar.gz">nginx.tar.gz</a>
and uncompress it:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-sh" data-lang="sh"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span>$ wget http://www.cs.toronto.edu/~soheil/csc309/nginx.tar.gz <span style="color:#f92672">&amp;&amp;</span> tar -xvzf nginx.tar.gz
</code></pre></div><ul>
<li>It creates an nginx directory for you. The config file
is in <code>nginx/conf/nginx.conf</code>.</li>
<li>We have provided a script named <code>nginx</code> in the directory.
To run <code>nginx</code>, go to the <code>nginx</code> directory (<code>cd nginx</code>) and
run <code>./nginx ...</code>.</li>
</ul>
<h3 id="ubuntu">Ubuntu</h3>
<p>Install <code>nginx</code> using <code>apt-get</code>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-sh" data-lang="sh"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span>$ sudo apt-get install nginx
</code></pre></div><p><strong>Notes:</strong></p>
<ul>
<li>The part of the <code>nginx</code>'s config file we need resides in <code>/etc/nginx/sites-enabled/default</code>.</li>
<li>To edit the config file or run <code>nginx</code>, you need to use <code>sudo</code>.</li>
</ul>
<h3 id="mac-os">Mac OS</h3>
<p>Install <a href="http://brew.sh"><code>homebrew</code></a>, and then install <code>nginx</code> using <code>brew</code>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-sh" data-lang="sh"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span>$ brew install nginx
</code></pre></div><p><strong>Notes:</strong></p>
<ul>
<li><code>nginx</code>'s config file is in <code>/usr/local/etc/nginx/nginx.conf</code>.</li>
<li>To edit the config file or run <code>nginx</code>, you need to use <code>sudo</code>:
<code>sudo nano /usr/local/etc/nginx/nginx.conf</code> and
<code>sudo nginx ...</code></li>
</ul>
<h2 id="configuration">Configuration</h2>
<h3 id="step-1----booting-servers-for-virtual-hosts">Step 1 &ndash; Booting Servers for Virtual Hosts</h3>
<p>Write three different node applications running on different ports
(say 8080, 8181, 8282) on your machine.</p>
<h3 id="step-2----configure-nginxs-port">Step 2 &ndash; Configure nginx's Port</h3>
<p>To do so, you need to edit your <code>nginx</code> config file.</p>
<p>In the config file, find the <code>server</code> section:</p>
<pre><code>server {
    listen       80;
    ...
    location / {
       ...
    }
    ...
}
</code></pre><p><strong>If you're using CDF</strong>, make sure you change <code>80</code> to a vacant port number
(ask for one from your instructor). If not, you can keep using <code>80</code> or
change the port if you will.</p>
<p><strong>Test nginx</strong></p>
<ol>
<li>Run <code>./nginx</code> on CDF, or run <code>sudo nginx</code> on your local machine.</li>
<li>Open the browser and log on to <code>localhost:$PORT</code> (replace <code>$PORT</code> with
the port number you configured for <code>nginx</code>).</li>
</ol>
<h3 id="step-3----configure-">Step 3 &ndash; Configure /</h3>
<p>Let say we want to configure <code>nginx</code> to route requests for
<code>/</code>, <code>/blog</code>, and <code>/mail</code>, respectively onto
<code>localhost:8080</code>, <code>localhost:8181</code>, and <code>localhost:8282</code>.</p>
<pre><code>                  +--- host --------&gt; node.js on localhost:8080
                  |
users --&gt; nginx --|--- host/blog ---&gt; node.js on localhost:8181
                  |
                  +--- host/mail ---&gt; node.js on localhost:8282
</code></pre><p>To route <code>/</code>, you need to edit your <code>nginx</code> config file.</p>
<p>In the config file, find the <code>server</code> section:</p>
<pre><code>server {
    listen       80;
    ...
    location / {
       ...
    }
    ...
}
</code></pre><p>This section is simply telling <code>nginx</code> how it should serve HTTP requests.</p>
<p>Now, change the location section to this snippet:</p>
<pre><code>server {
    listen       ...;
    ...
    location / {
        proxy_pass http://127.0.0.1:8080;
    }
    ...
}
</code></pre><p><code>proxy_pass</code> simply tells <code>nginx</code> to forward requests to <code>/</code> to the
server listening on <code>http://127.0.0.1:8080</code>.</p>
<h3 id="step-4----reload-nginxs-configuration">Step 4 &ndash; Reload nginx's Configuration</h3>
<p>To reload <code>nginx</code>'s configuration run:
<code>nginx -s reload</code> on your machine.</p>
<p>Referesh your browser. <em>Do you see the output from your <code>node.js</code> application?</em>
If yes, you are all set. If no, there is a problem with your config.</p>
<h3 id="step-5----add-blog-and-mail">Step 5 &ndash; Add /blog and /mail</h3>
<p>To redirect <code>/mail</code> and <code>/blog</code>, you simply need to add new entries
the location section in the config file:</p>
<pre><code>server {
    listen       ...;
    ...
    location / {
        proxy_pass http://127.0.0.1:8080;
    }
<pre><code>location /blog {
    proxy_pass http://127.0.0.1:8181;
}

location /mail {
    proxy_pass http://127.0.0.1:8282;
}
...
</code></pre>
<p>}
</code></pre><h3 id="step-6----reload-your-nginx-configuration">Step 6 – Reload Your nginx Configuration</h3></p>
<p>Run <code>nginx -s reload</code> on your machine.</p>
<p>Log onto <code>localhost:$PORT/blog</code> in your browser.
<em>Do you see the output from your second <code>node.js</code> application?</em></p>
<p>Then log onto <code>localhost:$PORT/mail</code>.
<em>Do you see the output from your third <code>node.js</code> application?</em></p>
<p>If yes &amp; yes, you are all set. If no, there is a problem with your config.</p>
<h3 id="step-7----rewriting-requests">Step 7 &ndash; Rewriting Requests</h3>
<p>Now as you might have noticed in Step 6, nginx sends the same
HTTP request to your <code>node.js</code> web apps which results into a 404 error.
Why? Because, your <code>node.js</code> web application serves requests from <code>/</code>
not from <code>/blog</code> and <code>/mail</code>. But, <code>nginx</code> is sending requests to <code>/blog</code> and
<code>/mail</code>.</p>
<p>To fix this issue, we need rewrite the URL so that it matches the URL
you can serve on your <code>node.js</code> applications.</p>
<p>To correctly rewrite URLs change your config file to match the following snippet:</p>
<pre><code>server {
    listen       ...;
    ...
    location / {
        proxy_pass http://127.0.0.1:8080;
    }
<pre><code>location /blog {
    rewrite ^/blog(.*) /$1 break;
    proxy_pass http://127.0.0.1:8181;
}

location /mail {
    rewrite ^/mail(.*) /$1 break;
    proxy_pass http://127.0.0.1:8282;
}
...
</code></pre>
<p>}
</code></pre><p>This rewrite commands are simple regular expressions that transform
strings like <code>/blogWHAT_EVER</code> and <code>/mailWHAT_EVER</code> to <code>/WHAT_EVER</code>
in the HTTP requests.</p></p>
<h3 id="step-8----reload-and-test">Step 8 &ndash; Reload and Test.</h3>
<p>All set?</p>
<h3 id="exercise-1">Exercise 1</h3>
<p>Configure your nginx to redirect URLs from <code>/google</code> to <code>http://www.google.com</code></p>
<h3 id="step-9-optional----redirecting-based-on-host-name">Step 9 (optional) &ndash; Redirecting Based on Host Name</h3>
<p>Let say you want to host <code>example1.com</code>, <code>example2.com</code>, and <code>example3.com</code>
on your machine, respectively to <code>localhost:8080</code>, <code>localhost:8181</code>, and
<code>localhost:8282</code>.</p>
<p><strong>Note:</strong> Since you don't have access to a DNS server, you should
add domain name entries to your <code>/etc/hosts</code> (you can't do this on CDF machines):</p>
<pre><code>...
127.0.0.1 example1.com example2.com example3.com
...
</code></pre><p>To proxy <code>eaxmple1.com</code> we can't use the location part of the default server.
Instead we need to add another server section with a <code>server_name</code> set
to our virtual host (e.g., <code>example1.com</code>, &hellip;), and then a simple location
section that tells <code>nginx</code> how to proxy the requests:</p>
<pre><code>server {
    listen       80;
    server_name  example1.com;
<pre><code>location / {
    proxy_pass http://127.0.0.1:8080;
}
</code></pre>
<p>}</p>
<p>server {
listen       80;
server_name  example2.com;</p>
<pre><code>location / {
    proxy_pass http://127.0.0.1:8181;
}
</code></pre>
<p>}</p>
<p>server {
listen       80;
server_name  example3.com;</p>
<pre><code>location / {
    proxy_pass http://127.0.0.1:8282;
}
</code></pre>
<p>}</p>
<p></code></pre><p>Simple, ha?!</p></p>

        </div>

        

<div class="share-box center-align" aria-hidden="true">
  <ul class="share">
    <li>
      <a class="facebook"
        href="https://www.facebook.com/sharer.php?u=https%3a%2f%2fgeraldo.dev%2fposts%2ffixme%2fnginx-proxy%2f"
        aria-label="share on Facebook"
        target="_blank" rel="noopener">
        <span class="mdi mdi-48px mdi-facebook"></span>
      </a>
    </li>

    <li>
      <a class="twitter"
         href="https://twitter.com/intent/tweet?url=https%3a%2f%2fgeraldo.dev%2fposts%2ffixme%2fnginx-proxy%2f&amp;text=Virtual%20Hosts%20on%20nginx%20%28CSC309%29"
         target="_blank" rel="noopener">
        <span class="mdi mdi-48px mdi-twitter"></span>
      </a>
    </li>

    <li>
      <a class="linkedin"
         href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fgeraldo.dev%2fposts%2ffixme%2fnginx-proxy%2f&amp;title=Virtual%20Hosts%20on%20nginx%20%28CSC309%29"
         target="_blank" rel="noopener">
        <span class="mdi mdi-48px mdi-linkedin"></span>
      </a>
    </li>

    <li>
      <a class="email"
         href="mailto:?subject=Virtual%20Hosts%20on%20nginx%20%28CSC309%29&amp;body=https%3a%2f%2fgeraldo.dev%2fposts%2ffixme%2fnginx-proxy%2f">
        <span class="mdi mdi-48px mdi-email"></span>
      </a>
    </li>

  </ul>
  <span>Compartilhe!</span>
</div>




        <div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "geraldo-dev" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
        <script>
var disqus_config = function () {
  this.language = "pt";
};
</script>

      </div>

    </main>


    
        <footer class="page-footer orange">
  <div class="container">
    <div class="row">
      <div class="col l9 s12">
        <h5 class="white-text">Você tem uma grande ideia?</h5>
        <p class="grey-text text-lighten-4">
          <ul>
            
          </ul>
        </p>

        <p class="grey-text text-lighten-4">
          Vamos marcar um café, talvez a solução seja muito mais simples do que você imagina.
        </p>
      </div>
      <div class="col l3 s12">
        <h5 class="white-text">Contatos</h5>
        <ul>
        
          <li>
            <a class="white-text" href="https://geraldo.dev">
              <span class="mdi mdi-24px mdi-web"></span>
              https://geraldo.dev
            </a>
          </li>
        
          <li>
            <a class="white-text" href="mailto:geraldolsribeiro@gmail.com">
              <span class="mdi mdi-24px mdi-email"></span>
              geraldo@intmain.io
            </a>
          </li>
        
          <li>
            <a class="white-text" href="https://api.whatsapp.com/send?phone=5512982302703&amp;text=Ol%c3%a1%20Geraldo!">
              <span class="mdi mdi-24px mdi-whatsapp"></span>
              (12) 9 8230 2703
            </a>
          </li>
        
          <li>
            <a class="white-text" href="https://twitter.com/geraldo_dev">
              <span class="mdi mdi-24px mdi-twitter"></span>
              geraldo_dev
            </a>
          </li>
        
          <li>
            <a class="white-text" href="https://www.instagram.com/geraldo.dev/">
              <span class="mdi mdi-24px mdi-instagram"></span>
              geraldo.dev
            </a>
          </li>
        
          <li>
            <a class="white-text" href="https://www.linkedin.com/in/geraldolsribeiro/">
              <span class="mdi mdi-24px mdi-linkedin"></span>
              geraldolsribeiro
            </a>
          </li>
        
          <li>
            <a class="white-text" href="https://www.facebook.com/geraldolsribeiro">
              <span class="mdi mdi-24px mdi-facebook"></span>
              geraldolsribeiro
            </a>
          </li>
        
          <li>
            <a class="white-text" href="https://github.com/geraldolsribeiro">
              <span class="mdi mdi-24px mdi-github-circle"></span>
              geraldolsribeiro
            </a>
          </li>
        
          <li>
            <a class="white-text" href="https://t.me/geraldolsribeiro">
              <span class="mdi mdi-24px mdi-telegram"></span>
              geraldolsribeiro
            </a>
          </li>
        
          <li>
            <a class="white-text" href="#ZgotmplZ">
              <span class="mdi mdi-24px mdi-skype"></span>
              geraldolsribeiro
            </a>
          </li>
        
          <li>
            <a class="white-text" href="https://codepen.io/geraldolsribeiro/">
              <span class="mdi mdi-24px mdi-codepen"></span>
              geraldolsribeiro
            </a>
          </li>
        
          <li>
            <a class="white-text" href="https://stackoverflow.com/users/554111/geraldo-luis-da-silva-ribeiro">
              <span class="mdi mdi-24px mdi-stack-overflow"></span>
              Stack overflow
            </a>
          </li>
        
          <li>
            <a class="white-text" href="https://scholar.google.com.br/citations?user=qsuG5ZkAAAAJ">
              <span class="mdi mdi-24px mdi-school"></span>
              Google Scholar
            </a>
          </li>
        
        </ul>
      </div>
    </div>
  </div>

    <div class="fixed-action-btn">
      <a class="btn-floating btn-large waves-effect waves-light ">
        <i class="large material-icons">chat</i>
      </a>
      <ul>
        
        
          <li>
              <a class="btn-floating waves-effect waves-light green darken-4"
                title="Chame pelo whatsapp!"
                target="_blank"
                href="https://api.whatsapp.com/send?phone=5512982302703&amp;text=Ol%c3%a1,%20Geraldo!">
              <span class="mdi mdi-24px mdi-whatsapp"></span>
            </a>
          </li>
        
      </ul>
    </div>


  <div class="footer-copyright">
    <div class="container">
      Feito com <i class="material-icons yellow-text" style="vertical-align: middle;">favorite</i> por Geraldo Ribeiro
    </div>
  </div>
</footer>

    

    
        






<script type="text/javascript" src="https://geraldo.dev/app.min.59882aba5a267177ea44b8e23767eb6092ffbd0fba04434f754edcc58be60ec5.js" integrity="sha256-WYgqulomcXfqRLjiN2frYJL/vQ&#43;6BENPdU7cxYvmDsU=" media="screen"></script>


    
</body>
</html>
