<!DOCTYPE html>
<html lang="pt-br">

<head>

    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.0" />
<base href="https://geraldo.dev/">
<title>Biblioteca pqxx | geraldo.dev</title>
<link rel="canonical" href="https://geraldo.dev/posts/fixme/postgres-pqxx/">
<meta name="generator" content="Hugo 0.62.0" />


    <meta property="og:type" content="article" />
    <meta property="article:published_time" content="06/09/2018">



    <meta property="og:image" content="https://geraldo.dev/img/open_graph_02_1200x1200.jpg" />

    <meta property="og:description" content="Tecnologia, c&#43;&#43;, web, linux, git, desenvolvimento de software, dicas, tutoriais e notícias sobre o mundo opensource" />
    <meta property="og:url" content="https://geraldo.dev/posts/fixme/postgres-pqxx/" />
    <meta property="og:site_name" content="geraldo.dev" />
    <meta property="og:title" content="Biblioteca pqxx" />





    <meta name="description" content="Tecnologia, c&#43;&#43;, web, linux, git, desenvolvimento de software, dicas, tutoriais e notícias sobre o mundo opensource">
    
<meta name="author" content="Geraldo Ribeiro">

<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-139336679-1', 'auto');
	
	ga('send', 'pageview');
}
</script>



<link rel="stylesheet" async href="https://fonts.googleapis.com/icon?family=Material+Icons">
<link rel="stylesheet" async href="https://cdn.materialdesignicons.com/2.8.94/css/materialdesignicons.min.css">



<link rel="stylesheet"
      href="https://geraldo.dev/style.main.min.9e3ce174be768153dcf516f5eac5a7697a43da9708d5b1290103e0a7195c5a5c.css"
      integrity="sha256-njzhdL52gVPc9Rb16sWnaXpD2pcI1bEpAQPgpxlcWlw="
      media="screen" async>





</head>

<body>
    
        <header>
            <nav class="light-blue lighten-1" role="navigation">
    <div class="nav-wrapper container">
        <a id="logo-container" href="https://geraldo.dev/" class="brand-logo">geraldo.dev</a>


        <a href="#" data-target="mobile-demo" class="sidenav-trigger"><i class="material-icons">menu</i></a>
        <ul class="right hide-on-med-and-down">
            
<li><a href="/">Home</a></li>

<li><a href="/posts">Posts</a></li>

<li><a href="/publications">Artigos</a></li>

<li><a href="/projects">Projetos</a></li>


        </ul>
    </div>
</nav>

<ul class="sidenav" id="mobile-demo">
  
<li><a href="/">Home</a></li>

<li><a href="/posts">Posts</a></li>

<li><a href="/publications">Artigos</a></li>

<li><a href="/projects">Projetos</a></li>


</ul>


        </header>
    

    

    <main>
      <div class="page container">

        

        <div class="row">
          <div class="col s12 m6 center-align grey-text">
            Publicado em: 06/Sep/2018
          </div>
          
          <div class="col s12 m6 center-align grey-text">
            Atualizado em: 08/Jan/2020
          </div>
          
        </div>

        
        
        


        <h1>Biblioteca pqxx</h1>

        
<aside class="table-of-contents">
  <header>
    <h3>Sumário</h3>
  </header>
  <ul>
    <li><a href="https://geraldo.dev/posts/fixme/postgres-pqxx/#introduo">Introdução</a></li>
    <li><a href="https://geraldo.dev/posts/fixme/postgres-pqxx/#transaes">Transações</a></li>
    <li><a href="https://geraldo.dev/posts/fixme/postgres-pqxx/#queries">Queries</a></li>
    <li><a href="https://geraldo.dev/posts/fixme/postgres-pqxx/#completando-a-transao">Completando a transação</a></li>
    <li><a href="https://geraldo.dev/posts/fixme/postgres-pqxx/#outros-tipos-de-transao-nontransaction-e-robusttransaction">Outros tipos de transação (nontransaction e robusttransaction)</a></li>
    <li><a href="https://geraldo.dev/posts/fixme/postgres-pqxx/#conjunto-de-resultados">Conjunto de resultados</a></li>
    <li><a href="https://geraldo.dev/posts/fixme/postgres-pqxx/#linhas">Linhas</a></li>
    <li><a href="https://geraldo.dev/posts/fixme/postgres-pqxx/#evite-o-uso-dos-algortmos-find-e-count">Evite o uso dos algorítmos find() e count()</a></li>
    <li><a href="https://geraldo.dev/posts/fixme/postgres-pqxx/#colunas-fields">Colunas \(fields\)</a></li>
    <li><a href="https://geraldo.dev/posts/fixme/postgres-pqxx/#nomes-de-tipos-qualificados">Nomes de tipos qualificados</a></li>
    <li><a href="https://geraldo.dev/posts/fixme/postgres-pqxx/#relao-entre-libpqxx-e-libpq">Relação entre libpqxx e libpq</a>
      <ul>
        <li><a href="https://geraldo.dev/posts/fixme/postgres-pqxx/#exemplo-de-aplicao">Exemplo de aplicação</a></li>
      </ul>
    </li>
    <li><a href="https://geraldo.dev/posts/fixme/postgres-pqxx/#objetos-grandes">Objetos grandes</a></li>
    <li><a href="https://geraldo.dev/posts/fixme/postgres-pqxx/#notificao-e-escuta">Notificação e escuta</a></li>
    <li><a href="https://geraldo.dev/posts/fixme/postgres-pqxx/#set-variable-e-get-variable">set_variable() e get_variable()</a></li>
    <li><a href="https://geraldo.dev/posts/fixme/postgres-pqxx/#referncias">Referências</a></li>
  </ul>

</aside>




        <div class="gr-main-content">
        <h2 id="introduo">Introdução</h2>
<p>Para padronizar o desenvolvimento foi criado o pacote <code>ThirdParty-libpqxx</code> contendo a última versão estável (github) da biblioteca <code>libpqxx</code>. Veja como <a href="/chapter-tecnologias/pqxx-preparacao-do-ambiente">preparar o ambiente</a>.</p>
<p>Numa aplicação <code>libpqxx</code> todos os comandos são executados usando um objeto derivado da classe <code>transaction_base</code> que qual represetna um transação do lado do servidor.</p>
<p>A cada comando é executado, um novo conjunto de resultados é retornado pelo servidor é armazeando num objeto da classe <code>result</code>.</p>
<p>Dento de um objeto <code>result</code> há uma coleção de zero ou mais objetos da classe <code>tuple</code>.</p>
<p>Uma <code>tuple</code> representa uma única linha do resultado retornado na forma de uma coleção de objetos do tipo <code>field</code>.</p>
<p>Cada field representa um único valor (e seus metadados).</p>
<h2 id="transaes">Transações</h2>
<p>Para executar uma <code>query</code> é necessário utilizar um objeto <code>transaction&lt;&gt;</code> (ou qualquer de seus derivados). O construtor do transaction&lt;&gt; espera receber um ou dois argumentos:</p>
<pre><code>transaction( connection_base &amp; conn, const std::string &amp; transactionName );
transaction( connection_base &amp; conn );
</code></pre><p>Cada transaction&lt;&gt; é anexado a uma única conexão utilizada para enviar comandos ao servidor e retornar os resultados.</p>
<p>Um nome para a transação pode ser informado ao construtor para que mensagens de erro lançadas pela transação sejam mais claras principalmente em aplicações mais complexas.</p>
<p>Na documentação está indicado que o nome da transação precisa começar com uma letra e somente pode conter letras e números.</p>
<blockquote>
<p>FIXME: Verificar espaços</p>
<p>FIXME: Incluir rotina no GrDB para filtrar o nome da transação antes de passar a libpqxx</p>
</blockquote>
<p>O tipo transaction&lt;&gt; é uma classe template, parametrizada para o nível de isolamento que você deseja garantir. Como o servidor PostgreSQL somente oferece dois tipos nível de isolamento, voce pode escolher entre <code>read_committed</code> ou <code>serializable</code>. O nível padrão é <code>read_committed</code>, então as três definições a seguir são equivalentes:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-cpp" data-lang="cpp"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span>transaction <span style="color:#a6e22e">myTransaction</span>( myConnection );  
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span>transaction<span style="color:#f92672">&lt;</span><span style="color:#f92672">&gt;</span> myTransaction( myConnection );  
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3</span>work <span style="color:#a6e22e">myTransaction</span>( myConnection );
</code></pre></div><p>A <code>libpqxx</code> define uma classe alias para transaction chamado <code>work</code>.</p>
<h2 id="queries">Queries</h2>
<p>Depois de criado o objeto de transação utilize o método <code>exec</code> para executar comandos no servidor.</p>
<p>A classe <code>transaction&lt;&gt;</code> define três tipo funções <code>exec</code>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-cpp" data-lang="cpp"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span>result <span style="color:#a6e22e">exec</span>( <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> queryText[], <span style="color:#66d9ef">const</span> std<span style="color:#f92672">:</span><span style="color:#f92672">:</span>string <span style="color:#f92672">&amp;</span> description );  
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span>result <span style="color:#a6e22e">exec</span>( <span style="color:#66d9ef">const</span> std<span style="color:#f92672">:</span><span style="color:#f92672">:</span>string queryText, <span style="color:#66d9ef">const</span> std<span style="color:#f92672">:</span><span style="color:#f92672">:</span>string <span style="color:#f92672">&amp;</span> description );  
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3</span>result <span style="color:#a6e22e">exec</span>( <span style="color:#66d9ef">const</span> std<span style="color:#f92672">:</span><span style="color:#f92672">:</span>stringstream queryText, <span style="color:#66d9ef">const</span> std<span style="color:#f92672">:</span><span style="color:#f92672">:</span>string <span style="color:#f92672">&amp;</span> description );
</code></pre></div><p>O formato da query pode ser uma string com terminador nulo (ao estilo do C), uma <code>std::string</code> ou uma <code>std::stringstream</code>.<br>
A descrição é opcional e será incluída em algumas (não todas) das mensagens de erro.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-cpp" data-lang="cpp"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span>std<span style="color:#f92672">:</span><span style="color:#f92672">:</span>string myCommand( <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">SELECT * FROM customers</span><span style="color:#e6db74">&#34;</span> );
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span><span style="color:#66d9ef">try</span> {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span>  result myResult <span style="color:#f92672">=</span> myTransaction.exec( myCommand, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Get Customer List</span><span style="color:#e6db74">&#34;</span> );
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span>} <span style="color:#66d9ef">catch</span>( runtime_error <span style="color:#f92672">&amp;</span> e ) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span>  cerr <span style="color:#f92672">&lt;</span><span style="color:#f92672">&lt;</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Error detected:</span><span style="color:#e6db74">&#34;</span> <span style="color:#f92672">&lt;</span><span style="color:#f92672">&lt;</span> e.what();
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span>} <span style="color:#66d9ef">catch</span>( exception <span style="color:#f92672">&amp;</span> e ) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span>  cerr <span style="color:#f92672">&lt;</span><span style="color:#f92672">&lt;</span> e.what();
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span>} <span style="color:#66d9ef">catch</span>( ... ) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span>  cerr <span style="color:#f92672">&lt;</span><span style="color:#f92672">&lt;</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Unknown exception caught</span><span style="color:#e6db74">&#34;</span> <span style="color:#f92672">&lt;</span><span style="color:#f92672">&lt;</span> endl;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span>}
</code></pre></div><p>Uma chamada <code>exec</code> vai bloquear até que o comando complete e o resultado seja retornado ou até que uma exceção seja lançada.</p>
<p>A libpqxx não provê uma chamada não bloqueante (pelo menos não por enquanto).</p>
<p>Utilize <code>sqlesc()</code> para tratar as strings para evitar SQL injection.</p>
<p>Considere o exemplo:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-sql" data-lang="sql"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span style="color:#66d9ef">SELECT</span> balance <span style="color:#66d9ef">FROM</span> customers <span style="color:#66d9ef">WHERE</span> customer_name <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;</span><span style="color:#e6db74">name</span><span style="color:#e6db74">&#39;</span>;
</code></pre></div><p>Agora imagine que o cliente digitou para o nome:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-sql" data-lang="sql"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span>Panky, Henry<span style="color:#e6db74">&#39;</span><span style="color:#e6db74">; DELETE FROM customers; COMMIT;
</span></code></pre></div><p>O que será executa é:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-sql" data-lang="sql"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span style="color:#66d9ef">SELECT</span> balance <span style="color:#66d9ef">FROM</span> customers <span style="color:#66d9ef">WHERE</span> name <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;</span><span style="color:#e6db74">Panky, Henry</span><span style="color:#e6db74">&#39;</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span><span style="color:#66d9ef">DELETE</span> <span style="color:#66d9ef">FROM</span> customers;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3</span><span style="color:#66d9ef">COMMIT</span>;
</code></pre></div><p>O que provalvelmente não é o que desejado.</p>
<p>O uso da função <code>sqlesc()</code>, para o exemplo acima, resultaria em:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-sql" data-lang="sql"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span>Panky, Henry<span style="color:#e6db74">&#39;</span><span style="color:#e6db74">&#39;</span>;<span style="color:#66d9ef">DELETE</span> <span style="color:#66d9ef">FROM</span> customer; <span style="color:#66d9ef">COMMIT</span>;
</code></pre></div><p>Note que a aspas simple no comando original foi duplicada, fazendo com que a query fique mais segura (e neste caso retornaria um resulto vazio).</p>
<h2 id="completando-a-transao">Completando a transação</h2>
<p>Como a <code>libpqxx</code> executa todos os comandos dentro de uma transação é necessário completá-la como as funções <code>commit</code> ou <code>abort</code>.<br>
É importante lembrar que se a transação não for explicitamente confirmada pelo <code>commit</code> ela será automaticamente abortada quando o objeto de transação for destruído.</p>
<p>Quando a transação é completada, o conjunto de dados resultado e metadados estarão disponíveis, mas cuidado com um resultado vindo de uma transação abortada (deve ser tratado como suspeito).</p>
<h2 id="outros-tipos-de-transao-nontransaction-e-robusttransaction">Outros tipos de transação (nontransaction e robusttransaction)</h2>
<p>A classe template <code>transaction&lt;&gt;</code> somente uma das três classes de transação da <code>libpqxx</code>.</p>
<p>A classe <code>robusttransaction&lt;&gt;</code> tem a mesma interface da <code>transaction&lt;&gt;</code> e deve ser usada do mesmo modo.<br>
A <code>libpqxx</code> tenta se reconectar se a conexão cair. Imagine que a conexão caiu no memento que em a aplicação executou o COMMIT, mas antes que o servidor tenha a chance de enviar a resposta. O COMMIT foi executado mesmo? a <code>robusttransaction</code> cuida destes casos escrevendo os registros numa área de log especial do servidor. Quando a conexão for reestabelecida a <code>robusttransaction</code> busca pelo log e se encontrar está tudo certo e o COMMIT foi concluído, se o log não existir a transação é abortada e pode ser refeita.</p>
<p>Se você está executando queries somente para leitura, deve usar a classe <code>nontransaction</code> no lugar da <code>transaction&lt;&gt;</code>.<br>
Quando executar comandos através de um objeto <code>nontransaction</code> não é necessário executar <code>commit</code> ou <code>abort</code> para finalizar a transação, pois o comando é automaticamente &ldquo;commitado&rdquo; quando estiver completo.</p>
<h2 id="conjunto-de-resultados">Conjunto de resultados</h2>
<p>Todas as funções <code>transaction&lt;&gt;::exec()</code> retornam um objeto da classe <code>result</code>.<br>
Um <code>result</code> é um container compatível com STL que contêm os dados e metadados retornados pelo comando.<br>
Como é um container padrão, contém funções tais como:</p>
<ul>
<li><code>size()</code> que retorna o número de linhas no resultado;</li>
<li><code>empty()</code> que retorna verdadeiro quando <code>size()</code> for zero; e</li>
<li><code>clear()</code> que discarta o conjunto de resultados.</li>
</ul>
<p>O <code>result</code> é um container que contêm <code>tuples</code> (linhas) retornadas pelo comando.<br>
Uma <code>tuple</code> é um container que contêm <code>fields</code>.</p>
<h2 id="linhas">Linhas</h2>
<p>A classe <code>result</code> oferece três métodos para obter as <code>tuples</code> contidas nele. O primeiro é o operador <code>[]</code> que retorna a <code>tuple</code> por um índice (zero-based).</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-cpp" data-lang="cpp"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span>result myResult <span style="color:#f92672">=</span> myTransaction.exec( myCommand, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Get Customer List</span><span style="color:#e6db74">&#34;</span> );
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span>tuple firstRow  <span style="color:#f92672">=</span> myResult[<span style="color:#ae81ff">0</span>];
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3</span>tuple secondRow <span style="color:#f92672">=</span> myResult[<span style="color:#ae81ff">1</span>];
</code></pre></div><p>Como qualquer container, chamando <code>result::operator[]()</code> com um índice fora da faixa o resultado é indefinido, mas geralmente é lixo. Use o método <code>at()</code> para maior segurança.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-cpp" data-lang="cpp"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span>result myResult <span style="color:#f92672">=</span> myTransaction.exec( myCommand, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Get Customer List</span><span style="color:#e6db74">&#34;</span> );
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span><span style="color:#66d9ef">try</span> {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3</span> tuple firstRow  <span style="color:#f92672">=</span> myResult.at( <span style="color:#ae81ff">0</span> );
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4</span> tuple secondRow <span style="color:#f92672">=</span> myResult.at( <span style="color:#ae81ff">1</span> );
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5</span>} <span style="color:#66d9ef">catch</span>( out_of_range e ) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6</span> <span style="color:#75715e">// Handle out_of_range error here
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7</span><span style="color:#75715e"></span>}
</code></pre></div><p>Pode ser utilizado os iteradores <code>result::begin()</code> e <code>result::end()</code>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-cpp" data-lang="cpp"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span>result myResult <span style="color:#f92672">=</span> myTransaction.exec( myCommand, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Get Customer List</span><span style="color:#e6db74">&#34;</span> );
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span>result<span style="color:#f92672">:</span><span style="color:#f92672">:</span>const_iterator I;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4</span><span style="color:#66d9ef">for</span>( I <span style="color:#f92672">=</span> myResult.begin(); I <span style="color:#f92672">!</span><span style="color:#f92672">=</span> myResult.end(); <span style="color:#f92672">+</span><span style="color:#f92672">+</span>I ) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5</span>  <span style="color:#66d9ef">const</span> tuple tup <span style="color:#f92672">=</span> <span style="color:#f92672">*</span>I;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6</span>  processTuple( tup );
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7</span>}
</code></pre></div><blockquote>
<p>FIXME: verificar se dá para usar o for range do c++11 aqui</p>
</blockquote>
<p>O método <code>result::begin()</code> retorna um iterador que aponta para a primeira tupla do conjunto de resultados.</p>
<p>Um iterador é parecido com um ponteiro:</p>
<ul>
<li>Se voce derreferenciar um iterador usando o operador <code>*</code> irá obter uma cópia da tupla.</li>
<li>Se voce derreferenciar um iterador usando o operador <code>-&gt;</code> irá acessar os membros do objeto para o qual o iterador aponta.</li>
</ul>
<p>Como o <code>result::const_iterator</code> é um iterador compatível com STL, voce pode utilizar a maioria dos algorítmos STL.<br>
Eu digo &ldquo;a maioria&rdquo; pois a <code>libpqxx</code> não provê um iterador <code>non-const</code>, ou seja, não dá para usar algorítmos que alteram o objeto apontado. Não dá para usar <code>sort()</code>, <code>transform()</code>, <code>fill()</code>, <code>replace_if()</code>, <code>remove()</code> e <code>random_shuffle()</code>.</p>
<p>A maioria, senão todos, dos algorítmos STL esperam por pelo menos dois iteradores que definem a faixa de elementos na coleção.<br>
Por exemplo, <code>for_each()</code> espera dois iteradores e um <code>functor</code> e aplica o <code>functor</code> a cada elemento na faixa entre o primeiro e segundo iteradores.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-cpp" data-lang="cpp"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span>result myResult <span style="color:#f92672">=</span> myTransaction.exec( myCommand, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Get Customer List</span><span style="color:#e6db74">&#34;</span> );
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span>for_each( myResult.begin(), myResult.end(), printTuple );
</code></pre></div><p>Atenção ao definir a função <code>printTuple</code>:</p>
<ul>
<li><code>printTuple( tuple )</code> irá criar uma cópia da tupla</li>
<li><code>printTuple( const tuple &amp; )</code> irá passar por referência</li>
</ul>
<p>Como os iteradores agem como ponteiros, você pode realizar aritmética de ponteiros.<br>
Por exemplo, para avançar um iterador dois elementos use:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-cpp" data-lang="cpp"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span>result<span style="color:#f92672">:</span><span style="color:#f92672">:</span>const_iterator i <span style="color:#f92672">=</span> myResult.begin();
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span>i <span style="color:#f92672">=</span> i <span style="color:#f92672">+</span> <span style="color:#ae81ff">2</span>;
</code></pre></div><p>Funciona também do outro lado:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-cpp" data-lang="cpp"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span>result<span style="color:#f92672">:</span><span style="color:#f92672">:</span>const_iterator i <span style="color:#f92672">=</span> myResult.end();
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span>i <span style="color:#f92672">=</span> i <span style="color:#f92672">-</span> <span style="color:#ae81ff">2</span>;
</code></pre></div><p>Para pegar a quantidade de tuplas (prefiro usar o <code>size()</code>):</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-cpp" data-lang="cpp"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span style="color:#66d9ef">int</span> tupleCount <span style="color:#f92672">=</span> myResult.end() <span style="color:#f92672">-</span> myResult.beg();
</code></pre></div><p>Também está definido o iterador reverso <code>result::const_reverse_iterator</code>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-cpp" data-lang="cpp"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span>result myResult <span style="color:#f92672">=</span> myTransaction.exec( myCommand, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Get Customer List</span><span style="color:#e6db74">&#34;</span> );
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span>for_each( myResult.rbegin(), myResult.rend(), printTuple );
</code></pre></div><h2 id="evite-o-uso-dos-algortmos-find-e-count">Evite o uso dos algorítmos <code>find()</code> e <code>count()</code></h2>
<p>Voce pode estar tentado a utilizar <code>find()</code>, <code>find_if()</code>, <code>count()</code> e <code>count_if()</code> para pesquisar através das tuplas num resultado. Se possível, voce deveria evitar usar estas funçãoes <code>if</code>. Prefira refinar o <code>WHERE</code> da consulta e filtrar diretamente no servidor, pois melhora muito a performance.</p>
<h2 id="colunas-fields">Colunas (fields)</h2>
<p>Agora que já sabemos como acessar as linhas num <code>result</code>, é hora de ver como acessar os <code>fields</code> dentro da tupla.</p>
<p>A quantidade de colunas é dada por <code>tuple::size()</code></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-cpp" data-lang="cpp"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span style="color:#66d9ef">const</span> result<span style="color:#f92672">:</span><span style="color:#f92672">:</span>tuple <span style="color:#f92672">&amp;</span> myTuple <span style="color:#f92672">=</span> myResult[<span style="color:#ae81ff">0</span>];
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span>cout <span style="color:#f92672">&lt;</span><span style="color:#f92672">&lt;</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">This tuple holds </span><span style="color:#e6db74">&#34;</span> <span style="color:#f92672">&lt;</span><span style="color:#f92672">&lt;</span> myTuple.size() <span style="color:#f92672">&lt;</span><span style="color:#f92672">&lt;</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74"> columns</span><span style="color:#e6db74">&#34;</span> <span style="color:#f92672">&lt;</span><span style="color:#f92672">&lt;</span> endl;
</code></pre></div><p>Note que <code>tuple::size()</code> retornará o mesmo número de colunas mesmo que estas contenham valores NULL.</p>
<p>Existem dois mecanismos (<code>at e []</code>) e seis funções membros ([int, C, string] x 2) para obter o valor de uma coluna em uma tupla.</p>
<ul>
<li><code>tuple::operator[]()</code></li>
<li><code>tuple::at()</code> (preferido e dentro de um bloco try/catch)</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-cpp" data-lang="cpp"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span>result<span style="color:#f92672">:</span><span style="color:#f92672">:</span>field myField;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span>myField <span style="color:#f92672">=</span> myTuple[index];
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3</span>myField <span style="color:#f92672">=</span> myTuple.at( index );
</code></pre></div><p>A coluna pode ser acessada pelo seu nome:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-cpp" data-lang="cpp"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span>result<span style="color:#f92672">:</span><span style="color:#f92672">:</span>field myField;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span>myField <span style="color:#f92672">=</span> myTuple[ <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">customer_name</span><span style="color:#e6db74">&#34;</span>];
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3</span>myField <span style="color:#f92672">=</span> myTuple.at( <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">customer_name</span><span style="color:#e6db74">&#34;</span> );
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5</span>std<span style="color:#f92672">:</span><span style="color:#f92672">:</span>string fieldName( <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">customer_name</span><span style="color:#e6db74">&#34;</span> );
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6</span>myField <span style="color:#f92672">=</span> myTuple[ fieldName ];
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7</span>myField <span style="color:#f92672">=</span> myTuple.at( fieldName );
</code></pre></div><p>Todos os membros agrupados abaixo:</p>
<pre><code>field operator[]( size_type index) const throw()
field operator[]( const char fieldName[] ) const
field operator[]( const std::string &amp; fieldName ) const
field at( size_type index ) const throw( std::out_of_range )
field at( const char fieldName[] ) const throw()
field at( const std::string &amp; fieldName ) const throw()
</code></pre><p>Voce pode tratar o <code>result</code> como um <code>array</code> bidimensional.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-cpp" data-lang="cpp"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span style="color:#66d9ef">for</span>( row <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; row <span style="color:#f92672">&lt;</span> myResult.size(); <span style="color:#f92672">+</span><span style="color:#f92672">+</span>row ) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span>  <span style="color:#66d9ef">for</span>( col <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; col <span style="color:#f92672">&lt;</span> myResult[<span style="color:#ae81ff">0</span>].size(); <span style="color:#f92672">+</span><span style="color:#f92672">+</span>col ) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3</span>    processField( myResult[row][col] );
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4</span>  }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5</span>}
</code></pre></div><p>Um objeto <code>field</code> pode dizer muito sobre si mesmo.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-cpp" data-lang="cpp"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span style="color:#66d9ef">for</span>( col <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; col <span style="color:#f92672">&lt;</span> myResult[<span style="color:#ae81ff">0</span>].size(); <span style="color:#f92672">+</span><span style="color:#f92672">+</span>col ) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span>  cout <span style="color:#f92672">&lt;</span><span style="color:#f92672">&lt;</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Column </span><span style="color:#e6db74">&#34;</span> <span style="color:#f92672">&lt;</span><span style="color:#f92672">&lt;</span> col <span style="color:#f92672">&lt;</span><span style="color:#f92672">&lt;</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74"> is named </span><span style="color:#e6db74">&#34;</span> <span style="color:#f92672">&lt;</span><span style="color:#f92672">&lt;</span> myResult[<span style="color:#ae81ff">0</span>][col].name() <span style="color:#f92672">&lt;</span><span style="color:#f92672">&lt;</span> endl;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3</span>}
</code></pre></div><p>Para recuperar o tipo de dado de um campo, use a função <code>field::type()</code>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-cpp" data-lang="cpp"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span>oid columnType <span style="color:#f92672">=</span> myField.type();
</code></pre></div><p><code>oid</code> é uma das linhas da tablea <code>pg_type</code>.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-sql" data-lang="sql"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span style="color:#66d9ef">SELECT</span> typname <span style="color:#66d9ef">FROM</span> pg_type <span style="color:#66d9ef">WHERE</span> oid <span style="color:#f92672">=</span> value;
</code></pre></div><p>Atualmente não dá para obter os modificadores de tipo (precisão ou faixa para tipos DECIMAL por exemplo).</p>
<p>Para saber se uma coluna é nula use <code>field::is_null()</code>.</p>
<p>Para saber o tamanho em bytes da coluna use <code>field::size()</code></p>
<p>Todos os valores são armazenados internamente como strings terminadas em null, e podem ser referenciados como por <code>field::c_str()</code>.</p>
<p>A <code>libpqxx</code> define um <code>operator&lt;&lt;</code> que permite omitir o <code>c_str()</code> quando escrevendo em um stream.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-cpp" data-lang="cpp"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span style="color:#66d9ef">for</span>( row <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; row <span style="color:#f92672">&lt;</span> myResult.size(); <span style="color:#f92672">+</span><span style="color:#f92672">+</span>row ) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span>  <span style="color:#66d9ef">for</span>( col <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; col <span style="color:#f92672">&lt;</span> myResult[<span style="color:#ae81ff">0</span>].size(); <span style="color:#f92672">+</span><span style="color:#f92672">+</span>col ) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3</span>    cout <span style="color:#f92672">&lt;</span><span style="color:#f92672">&lt;</span> myResult[row][col].c_str() <span style="color:#f92672">&lt;</span><span style="color:#f92672">&lt;</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74"> </span><span style="color:#e6db74">&#39;</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4</span>  }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5</span>  cout <span style="color:#f92672">&lt;</span><span style="color:#f92672">&lt;</span> endl;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6</span>}
</code></pre></div><p>As funções de conversão <code>bool field::to( T &amp; obj)</code> retornam <code>true</code> se a conversão foi realizado com sucesso, retornam <code>false</code> se o campo for <code>NULL</code> ou lançam uma exceção <code>std::domain_error</code> se falhar.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-cpp" data-lang="cpp"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span style="color:#66d9ef">const</span> result<span style="color:#f92672">:</span><span style="color:#f92672">:</span>field <span style="color:#f92672">&amp;</span> myField <span style="color:#f92672">=</span> myResult[<span style="color:#ae81ff">0</span>][<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">balance</span><span style="color:#e6db74">&#34;</span>];
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span><span style="color:#66d9ef">float</span> <span style="color:#a6e22e">fldValue</span>( <span style="color:#ae81ff">0.0F</span> );
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span><span style="color:#66d9ef">try</span> {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span>  <span style="color:#66d9ef">if</span>( myField.to( fldValue )) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span>    cout <span style="color:#f92672">&lt;</span><span style="color:#f92672">&lt;</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Customer balance: </span><span style="color:#e6db74">&#34;</span> <span style="color:#f92672">&lt;</span><span style="color:#f92672">&lt;</span> fldValue <span style="color:#f92672">&lt;</span><span style="color:#f92672">&lt;</span> endl;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span>  } <span style="color:#66d9ef">else</span> {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span>     cout <span style="color:#f92672">&lt;</span><span style="color:#f92672">&lt;</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Customer balance: NULL</span><span style="color:#e6db74">&#34;</span> <span style="color:#f92672">&lt;</span><span style="color:#f92672">&lt;</span> endl;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span>  }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span>} <span style="color:#66d9ef">catch</span>( std<span style="color:#f92672">:</span><span style="color:#f92672">:</span>domain_error ) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span>  cerr <span style="color:#f92672">&lt;</span><span style="color:#f92672">&lt;</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Can&#39;t convert customer_balance into float form</span><span style="color:#e6db74">&#34;</span> <span style="color:#f92672">&lt;</span><span style="color:#f92672">&lt;</span> endl;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span>}
</code></pre></div><p>Voce também pode prover um valor default para ser usado no lugar de NULL.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-cpp" data-lang="cpp"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span style="color:#66d9ef">const</span> result<span style="color:#f92672">:</span><span style="color:#f92672">:</span>field <span style="color:#f92672">&amp;</span> myField <span style="color:#f92672">=</span> myResult[<span style="color:#ae81ff">0</span>][<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">balance</span><span style="color:#e6db74">&#34;</span>];
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span><span style="color:#66d9ef">float</span> fldValue;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4</span><span style="color:#66d9ef">try</span> {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5</span>  myField.to( fldValue, <span style="color:#66d9ef">float</span>( <span style="color:#ae81ff">0.0F</span> )))
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6</span>  cout <span style="color:#f92672">&lt;</span><span style="color:#f92672">&lt;</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Customer balance: </span><span style="color:#e6db74">&#34;</span> <span style="color:#f92672">&lt;</span><span style="color:#f92672">&lt;</span> fldValue <span style="color:#f92672">&lt;</span><span style="color:#f92672">&lt;</span> endl;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7</span>} <span style="color:#66d9ef">catch</span>( std<span style="color:#f92672">:</span><span style="color:#f92672">:</span>domain_error ) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8</span>  cerr <span style="color:#f92672">&lt;</span><span style="color:#f92672">&lt;</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Can&#39;t convert customer_balance into float form</span><span style="color:#e6db74">&#34;</span> <span style="color:#f92672">&lt;</span><span style="color:#f92672">&lt;</span> endl;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">9</span>}
</code></pre></div><p>Note que não é necessário checar o retorno do <code>to()</code>, pois será um valor, 0.0F e se falha será pego pela exceção.</p>
<p><code>field:to()</code> sabe como converter <code>c_str()</code> nos seguintes tipos:</p>
<ul>
<li>long</li>
<li>unsigned long</li>
<li>int</li>
<li>unsigned int</li>
<li>short</li>
<li>unsigned short</li>
<li>float</li>
<li>double</li>
<li>long double</li>
<li>bool</li>
<li>std::string</li>
<li>std::stringstream</li>
</ul>
<p><code>field::as( const T &amp; defaultValue)</code> converte os mesmos tipos que o <code>to()</code> e é usada para criar um objeto do tipo do argumento.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-cpp" data-lang="cpp"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span style="color:#66d9ef">const</span> result<span style="color:#f92672">:</span><span style="color:#f92672">:</span>field <span style="color:#f92672">&amp;</span> myField <span style="color:#f92672">=</span> myResult[<span style="color:#ae81ff">0</span>][<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">balance</span><span style="color:#e6db74">&#34;</span>];
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span><span style="color:#66d9ef">try</span> {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3</span>  cout <span style="color:#f92672">&lt;</span><span style="color:#f92672">&lt;</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">New customer balance: </span><span style="color:#e6db74">&#34;</span> <span style="color:#f92672">&lt;</span><span style="color:#f92672">&lt;</span> myField.as( <span style="color:#66d9ef">float</span>(<span style="color:#ae81ff">0.0F</span>))<span style="color:#f92672">+</span><span style="color:#ae81ff">10.0F</span> <span style="color:#f92672">&lt;</span><span style="color:#f92672">&lt;</span> endl;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4</span>} <span style="color:#66d9ef">catch</span>( std<span style="color:#f92672">:</span><span style="color:#f92672">:</span>domain_error ) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5</span>  cerr <span style="color:#f92672">&lt;</span><span style="color:#f92672">&lt;</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Can&#39;t convert customer_balance into float form</span><span style="color:#e6db74">&#34;</span> <span style="color:#f92672">&lt;</span><span style="color:#f92672">&lt;</span> endl;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6</span>}
</code></pre></div><p>Note que não é preciso criar um objeto temporário do tipo float aqui, o que deixa o código mais legível.</p>
<p>Existe uma variante <code>field::as()</code> onde o typename indica o tipo de objeto a ser criado.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-cpp" data-lang="cpp"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span style="color:#66d9ef">const</span> result<span style="color:#f92672">:</span><span style="color:#f92672">:</span>field <span style="color:#f92672">&amp;</span> myField <span style="color:#f92672">=</span> myResult[<span style="color:#ae81ff">0</span>][<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">balance</span><span style="color:#e6db74">&#34;</span>];
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span><span style="color:#66d9ef">try</span> {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3</span>  cout <span style="color:#f92672">&lt;</span><span style="color:#f92672">&lt;</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">New customer balance: </span><span style="color:#e6db74">&#34;</span> <span style="color:#f92672">&lt;</span><span style="color:#f92672">&lt;</span> myField.as() <span style="color:#f92672">+</span> <span style="color:#ae81ff">10.0F</span> <span style="color:#f92672">&lt;</span><span style="color:#f92672">&lt;</span> endl;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4</span>} <span style="color:#66d9ef">catch</span>( std<span style="color:#f92672">:</span><span style="color:#f92672">:</span>domain_error )  {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5</span>  cerr <span style="color:#f92672">&lt;</span><span style="color:#f92672">&lt;</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Can&#39;t convert customer_balance into float (or balance is NULL)</span><span style="color:#e6db74">&#34;</span> <span style="color:#f92672">&lt;</span><span style="color:#f92672">&lt;</span> endl;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6</span>}
</code></pre></div><h2 id="nomes-de-tipos-qualificados">Nomes de tipos qualificados</h2>
<p>Todos os tipos de dados da <code>libpqxx</code> estão definidos no namespace  <code>pqxx</code>.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-cpp" data-lang="cpp"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span style="color:#66d9ef">using</span> <span style="color:#66d9ef">namespace</span> pqxx;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3</span><span style="color:#75715e">// ou
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4</span><span style="color:#75715e"></span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5</span><span style="color:#66d9ef">typedef</span> pqxx<span style="color:#f92672">:</span><span style="color:#f92672">:</span>result<span style="color:#f92672">:</span><span style="color:#f92672">:</span>tuple tuple; <span style="color:#75715e">// a synonym for &#39;pqxx: :result::tuple&#39;
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6</span><span style="color:#75715e"></span><span style="color:#66d9ef">typedef</span> pqxx<span style="color:#f92672">:</span><span style="color:#f92672">:</span>result<span style="color:#f92672">:</span><span style="color:#f92672">:</span>field field; <span style="color:#75715e">// a synonym for &#39;pqxx: :result::field&#39; 
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7</span><span style="color:#75715e"></span><span style="color:#66d9ef">typedef</span> pqxx<span style="color:#f92672">:</span><span style="color:#f92672">:</span>result<span style="color:#f92672">:</span><span style="color:#f92672">:</span>const_iterator result_iterator; <span style="color:#75715e">// You get the idea...
</span></code></pre></div><h2 id="relao-entre-libpqxx-e-libpq">Relação entre libpqxx e libpq</h2>
<p>A <code>libpqxx</code> é um lightweight wrapper sobre a interface da <code>lippq</code>, a qual é usada diretamente pelas aplicações PostgreSQL escrita em C.
Não duplica dados, apenas aponta para os dados retornados pela <code>libpq</code>.</p>
<h3 id="exemplo-de-aplicao">Exemplo de aplicação</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-cpp" data-lang="cpp"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span style="color:#66d9ef">using</span> <span style="color:#66d9ef">namespace</span> std;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span><span style="color:#66d9ef">using</span> <span style="color:#66d9ef">namespace</span> pqxx;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span><span style="color:#66d9ef">typedef</span> pqxx<span style="color:#f92672">:</span><span style="color:#f92672">:</span>result<span style="color:#f92672">:</span><span style="color:#f92672">:</span>tuple tuple;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span><span style="color:#66d9ef">typedef</span> vector widthVector;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span><span style="color:#75715e">// Forward function declarations
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span><span style="color:#75715e"></span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">getColumnWidths</span>(<span style="color:#66d9ef">const</span> result <span style="color:#f92672">&amp;</span> res, widthVector <span style="color:#f92672">&amp;</span> widths);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">printColumnHdrs</span>(<span style="color:#66d9ef">const</span> result <span style="color:#f92672">&amp;</span> res, <span style="color:#66d9ef">const</span> widthVector <span style="color:#f92672">&amp;</span> widths);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">printColumnVals</span>(<span style="color:#66d9ef">const</span> result <span style="color:#f92672">&amp;</span> res, <span style="color:#66d9ef">const</span> widthVector <span style="color:#f92672">&amp;</span> widths);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span><span style="color:#ae81ff">17</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>( <span style="color:#66d9ef">int</span> argc, <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span> argv[] )
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span>{
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span>  <span style="color:#66d9ef">try</span> {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span>    connection myConnection( argc <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">?</span> argv[<span style="color:#ae81ff">1</span>] <span style="color:#f92672">:</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">&#34;</span> );
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span>    transaction<span style="color:#f92672">&lt;</span><span style="color:#f92672">&gt;</span> myTransaction( myConnection, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Get Customer List</span><span style="color:#e6db74">&#34;</span> );
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span>    <span style="color:#66d9ef">const</span> result <span style="color:#f92672">&amp;</span> customerList <span style="color:#f92672">=</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17</span>    myTransaction.exec( <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">SELECT * FROM customers</span><span style="color:#e6db74">&#34;</span> );
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18</span>    widthVector columnWidths( customerList.columns());
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19</span>    getColumnWidths( customerList, columnWidths );
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20</span>    printColumnHdrs( customerList, columnWidths );
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21</span>    printColumnVals( customerList, columnWidths );
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22</span>    myTransaction.commit();
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23</span>  } <span style="color:#66d9ef">catch</span>( ... ) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24</span>    cerr <span style="color:#f92672">&lt;</span><span style="color:#f92672">&lt;</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Unknown exception caught</span><span style="color:#e6db74">&#34;</span> <span style="color:#f92672">&lt;</span><span style="color:#f92672">&lt;</span> endl;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25</span>    exit( EXIT_FAILURE );
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26</span>  }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27</span>  exit( EXIT_SUCCESS );
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28</span>}
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30</span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">getColumnWidths</span>( <span style="color:#66d9ef">const</span> result <span style="color:#f92672">&amp;</span> res, widthVector <span style="color:#f92672">&amp;</span> widths )
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31</span>{
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32</span>  result<span style="color:#f92672">:</span><span style="color:#f92672">:</span>size_type row;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33</span>  tuple<span style="color:#f92672">:</span><span style="color:#f92672">:</span>size_type col;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34</span>  <span style="color:#75715e">// Compute width of widest value in each column
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">for</span>( row <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; row <span style="color:#f92672">&lt;</span> res.size(); <span style="color:#f92672">+</span><span style="color:#f92672">+</span>row )
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36</span>  <span style="color:#66d9ef">for</span>( col <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; col <span style="color:#f92672">&lt;</span> res.columns(); <span style="color:#f92672">+</span><span style="color:#f92672">+</span>col )
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37</span>  <span style="color:#66d9ef">if</span>( res[row][col].size() <span style="color:#f92672">&gt;</span> widths[col] )
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38</span>  widths[col] <span style="color:#f92672">=</span> res[row][col].size();
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39</span>  <span style="color:#75715e">// Make room for any column name which happens to be
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40</span><span style="color:#75715e"></span>  <span style="color:#75715e">// longer than the widest value in that column
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">for</span>( col <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; col <span style="color:#f92672">&lt;</span> res.columns(); <span style="color:#f92672">+</span><span style="color:#f92672">+</span>col )
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42</span>  <span style="color:#66d9ef">if</span>( strlen( res.column_name( col )) <span style="color:#f92672">&gt;</span> widths[col] )
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43</span>  widths[col] <span style="color:#f92672">=</span> strlen( res.column_name( col ));
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44</span>}
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46</span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">printColumnHdrs</span>(<span style="color:#66d9ef">const</span> result <span style="color:#f92672">&amp;</span> res, <span style="color:#66d9ef">const</span> widthVector <span style="color:#f92672">&amp;</span> widths)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">47</span>{
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">48</span>  std<span style="color:#f92672">:</span><span style="color:#f92672">:</span>ostream out( cout.rdbuf()); <span style="color:#75715e">// Construct a new stream so we can
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">49</span><span style="color:#75715e"></span>  <span style="color:#75715e">// change the format flags and
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">50</span><span style="color:#75715e"></span>  <span style="color:#75715e">// options without mucking up cout
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">51</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">for</span>( tuple<span style="color:#f92672">:</span><span style="color:#f92672">:</span>size_type col <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; col <span style="color:#f92672">&lt;</span> res.columns(); <span style="color:#f92672">+</span><span style="color:#f92672">+</span>col )
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">52</span>  out <span style="color:#f92672">&lt;</span><span style="color:#f92672">&lt;</span> setw( widths[ col ] ) <span style="color:#f92672">&lt;</span><span style="color:#f92672">&lt;</span> left <span style="color:#f92672">&lt;</span><span style="color:#f92672">&lt;</span> res.column_name( col ) <span style="color:#f92672">&lt;</span><span style="color:#f92672">&lt;</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74"> </span><span style="color:#e6db74">&#34;</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">53</span>  out <span style="color:#f92672">&lt;</span><span style="color:#f92672">&lt;</span> endl;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">54</span>  <span style="color:#66d9ef">for</span>( tuple<span style="color:#f92672">:</span><span style="color:#f92672">:</span>size_type col <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; col <span style="color:#f92672">&lt;</span> res.columns(); <span style="color:#f92672">+</span><span style="color:#f92672">+</span>col )
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">55</span>  out <span style="color:#f92672">&lt;</span><span style="color:#f92672">&lt;</span> setw( widths[ col ] ) <span style="color:#f92672">&lt;</span><span style="color:#f92672">&lt;</span> setfill( <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">-</span><span style="color:#e6db74">&#39;</span> ) <span style="color:#f92672">&lt;</span><span style="color:#f92672">&lt;</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">&#34;</span> <span style="color:#f92672">&lt;</span><span style="color:#f92672">&lt;</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74"> </span><span style="color:#e6db74">&#34;</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">56</span>  out <span style="color:#f92672">&lt;</span><span style="color:#f92672">&lt;</span> endl;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">57</span>}
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">58</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">59</span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">printColumnVals</span>(<span style="color:#66d9ef">const</span> result <span style="color:#f92672">&amp;</span> res, <span style="color:#66d9ef">const</span> widthVector <span style="color:#f92672">&amp;</span> widths)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">60</span>{
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">61</span>  result<span style="color:#f92672">:</span><span style="color:#f92672">:</span>const_iterator i;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">62</span>  <span style="color:#66d9ef">for</span>( i <span style="color:#f92672">=</span> res.begin(); i <span style="color:#f92672">!</span><span style="color:#f92672">=</span> res.end(); <span style="color:#f92672">+</span><span style="color:#f92672">+</span>i )
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">63</span>  {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">64</span>    <span style="color:#66d9ef">const</span> tuple <span style="color:#f92672">&amp;</span> tup <span style="color:#f92672">=</span> <span style="color:#f92672">*</span>i;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">65</span>    <span style="color:#66d9ef">for</span>( tuple<span style="color:#f92672">:</span><span style="color:#f92672">:</span>size_type col <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; col <span style="color:#f92672">&lt;</span> tup.size(); <span style="color:#f92672">+</span><span style="color:#f92672">+</span>col )
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">66</span>    {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">67</span>      <span style="color:#75715e">// Note: because of a bug in some STL implementations,
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">68</span><span style="color:#75715e"></span>      <span style="color:#75715e">// setw() doesn&#39;t work as expected when followed
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">69</span><span style="color:#75715e"></span>      <span style="color:#75715e">// by a std::string so we convert to a const char *
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">70</span><span style="color:#75715e"></span>      <span style="color:#75715e">// instead
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">71</span><span style="color:#75715e"></span>      cout <span style="color:#f92672">&lt;</span><span style="color:#f92672">&lt;</span> setw( widths[ col ] ) <span style="color:#f92672">&lt;</span><span style="color:#f92672">&lt;</span> tup[col].c_str() <span style="color:#f92672">&lt;</span><span style="color:#f92672">&lt;</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74"> </span><span style="color:#e6db74">&#34;</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">72</span>    }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">73</span>    cout <span style="color:#f92672">&lt;</span><span style="color:#f92672">&lt;</span> endl;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">74</span>  }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">75</span>}
</code></pre></div><h2 id="objetos-grandes">Objetos grandes</h2>
<p>A maioria das tabela são definidas em termos de dados simples. O PostgreSQL
prove os tipos numérico, textual, date-time, geométrico e lógico. Mas e se
precisar armazenar fotos ou audio por exemplo?</p>
<p>Uma resposta é BLOB (binary large object), que é uma entrada na tabela de sistema
<code>pg_largeobjects</code>. Cada linha na <code>pg_largeobjects</code> armazena um chunk de 2KB do objeto.</p>
<p>Um alternativa ao BLOB é o BYTEA. Uma coluna do tipo BYTEA por armazenar
strings de bytes de tamanho arbitrário. É um VARCHAR turbo, com algumas
diferenças: pode armazenar o caractere NULL/0 (CHAR 48, veja
<a href="http://www.asciitable.com">www.asciitable.com</a>) e qualquer outro caractere de 8-bits.</p>
<p>BYTEA pode armazenar até 1GB. O PostgreSQL provê algumas funções para carregar um arquivo para um campo BYTEA facilmente.</p>
<p>Vamos dizer que voce precisa armazenar uma image para cada registro.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-sql" data-lang="sql"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span style="color:#66d9ef">CREATE</span> <span style="color:#66d9ef">TABLE</span> tapes
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span>(
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3</span> tape_id character(<span style="color:#ae81ff">8</span>),
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4</span> title character varying(<span style="color:#ae81ff">80</span>)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5</span> photo_id oid
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6</span>);
</code></pre></div><p>Lembre-se que não está armazenando a foto na tabela <code>tapes</code> e sim na
<code>pg_largeobjects</code> e que <code>photo_id</code> é só o identificador da linha da
<code>pg_largeobjects</code>.</p>
<p>Para armazenar a foto no PostgreSQL você pode usar a função <code>lo_import( filename )</code> que retorna <code>OID</code>.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-sql" data-lang="sql"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span style="color:#66d9ef">INSERT</span> <span style="color:#66d9ef">INTO</span> tapes <span style="color:#66d9ef">VALUES</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span>(
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3</span>  <span style="color:#e6db74">&#39;</span><span style="color:#e6db74">AA-55892</span><span style="color:#e6db74">&#39;</span>,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4</span>  <span style="color:#e6db74">&#39;</span><span style="color:#e6db74">Casablanca</span><span style="color:#e6db74">&#39;</span>,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5</span>  lo_import(<span style="color:#e6db74">&#39;</span><span style="color:#e6db74">/tmp/casablanca.jpg</span><span style="color:#e6db74">&#39;</span> )
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6</span>);
</code></pre></div><p>Voce pode usar a função <code>lo_export()</code> para salvar a image no filesystem novamente.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-sql" data-lang="sql"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span style="color:#66d9ef">SELECT</span> lo_export( photo_id, <span style="color:#e6db74">&#39;</span><span style="color:#e6db74">/tmp/casa2.jpg</span><span style="color:#e6db74">&#39;</span> ) <span style="color:#66d9ef">WHERE</span> tape_id <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;</span><span style="color:#e6db74">AA-5892</span><span style="color:#e6db74">&#39;</span>;
</code></pre></div><p><code>libpqxx</code> define quatro classes interrelacionadas para manipular objetos grandes:</p>
<ul>
<li><code>largeobject</code>: Um objeto <code>largeobject</code> armazena um ID de objeto grande ou loid;</li>
<li><code>largeobjectaccess</code>: Provê acesso de baixo nível ao objeto grande</li>
<li><code>olostream</code>: um <code>ostream</code> STL para escrever dentro do objeto</li>
<li><code>ilostream</code>: um <code>istream</code> STL para ler do objeto</li>
</ul>
<p>Voce pode criar um objeto vazio usando um objeto do tipo <code>largeobject</code> ou <code>largeobjectaccess</code>.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-cpp" data-lang="cpp"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span>largeobject( dbtransaction <span style="color:#f92672">&amp;</span> transaction );
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span>largeobjectaccess( dbtransaction <span style="color:#f92672">&amp;</span> transaction, openmode mode <span style="color:#f92672">=</span> ios<span style="color:#f92672">:</span><span style="color:#f92672">:</span>in <span style="color:#f92672">|</span> ios<span style="color:#f92672">:</span><span style="color:#f92672">:</span>out );
</code></pre></div><p>O argumento <code>mode</code> determina o que você pode fazer com o <code>largeobjectaccess</code>.</p>
<p>Você também pode criar um objeto e preenchê-lo com uma cópia de um arquivo existente usando o construtor:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-cpp" data-lang="cpp"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span>largeobject( dbtransaction <span style="color:#f92672">&amp;</span> transaction, std<span style="color:#f92672">:</span><span style="color:#f92672">:</span>string fileName );
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span>largeobjectaccess( dbtransaction <span style="color:#f92672">&amp;</span> transaction, std<span style="color:#f92672">:</span><span style="color:#f92672">:</span>string fileName, openmode mode <span style="color:#f92672">=</span> ios<span style="color:#f92672">:</span><span style="color:#f92672">:</span>in <span style="color:#f92672">|</span> ios<span style="color:#f92672">:</span><span style="color:#f92672">:</span>out );
</code></pre></div><p>Se a <code>libpqxx</code> não puder abrir o arquivo o construtor lança uma exceção do tipo <code>runtime_error</code>.</p>
<p>Se você obteve um loid do servidor, pode convertê-lo para <code>largeobject</code> com o construtor:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-cpp" data-lang="cpp"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span>largeobject( oid largeObjectID );
</code></pre></div><p>Ou pode convertê-lo para um <code>largeobjectaccess</code> usando este construtor:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-cpp" data-lang="cpp"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span>largeobjectaccess( dbtransaction <span style="color:#f92672">&amp;</span> transaction, oid largeObjectID );
</code></pre></div><p>Tendo o <code>largeobject</code> (ou <code>largeobjectaccess</code>), você pode recuperar o loid com a função <code>id()</code>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-cpp" data-lang="cpp"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span>oid largeobject<span style="color:#f92672">:</span><span style="color:#f92672">:</span>id();
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span>oid largeobjectaccess<span style="color:#f92672">:</span><span style="color:#f92672">:</span>id();
</code></pre></div><p>Para escrever para um arquivo use:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-cpp" data-lang="cpp"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span style="color:#66d9ef">void</span> largeobject<span style="color:#f92672">:</span><span style="color:#f92672">:</span>to_file( dbtransaction <span style="color:#f92672">&amp;</span> transaction, std<span style="color:#f92672">:</span><span style="color:#f92672">:</span>string fileName );
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span><span style="color:#66d9ef">void</span> largeobjectaccess<span style="color:#f92672">:</span><span style="color:#f92672">:</span>to_file( std<span style="color:#f92672">:</span><span style="color:#f92672">:</span>string fileName );
</code></pre></div><p>A diferença entre <code>largeobject</code> e <code>largeobjectaccess</code> é que o segundo provê três funções para escrever pacotes de dados e duas para ler:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-cpp" data-lang="cpp"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span>off_type <span style="color:#a6e22e">cwrite</span>( <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> data[], size_type byteCount ) <span style="color:#66d9ef">throw</span>();
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">write</span>( <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> data[], size_type byteCount );
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3</span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">write</span>( <span style="color:#66d9ef">const</span> std<span style="color:#f92672">:</span><span style="color:#f92672">:</span>string <span style="color:#f92672">&amp;</span> data );
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5</span>off_type <span style="color:#a6e22e">cread</span>( <span style="color:#66d9ef">char</span> destination[], size_type byteCount ) <span style="color:#66d9ef">throw</span>();
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6</span>size_type <span style="color:#a6e22e">read</span>( <span style="color:#66d9ef">char</span> destination[], size_type byteCount );
</code></pre></div><p>Finalmente, <code>largeobjectaccess</code> provê duas funções para &ldquo;se mover&rdquo; dentro de um objeto grande.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-cpp" data-lang="cpp"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span>pos_type <span style="color:#a6e22e">cseek</span>( off_type offset, seekdir origin ) <span style="color:#66d9ef">throw</span>();
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span>size_type <span style="color:#a6e22e">seek</span> ( size_type offset, seekdir origin );
</code></pre></div><p>As classes <code>olostream</code> e <code>ilostream</code> são derivadas de <code>std::iostream</code>.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-cpp" data-lang="cpp"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span>olostream( dbtransaction <span style="color:#f92672">&amp;</span> transaction, largeobject <span style="color:#f92672">&amp;</span> obj );
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span>olostream( dbtransaction <span style="color:#f92672">&amp;</span> transaction, oid objectID );
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3</span>ilostream( dbtransaction <span style="color:#f92672">&amp;</span> transaction, largeobject <span style="color:#f92672">&amp;</span> obj );
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4</span>ilostream( dbtransaction <span style="color:#f92672">&amp;</span> transaction, oid objectID );
</code></pre></div><p>Um <code>olostream</code> é um stream que permite anexar (append) um objeto C++ a um large-object.</p>
<p>Um <code>ilostream</code> é um stream que voce pode usar para criar um objeto C++ a partir do conteúdo de um large-object.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-cpp" data-lang="cpp"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span> myStream <span style="color:#f92672">&lt;</span><span style="color:#f92672">&lt;</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">This string is written to the large object</span><span style="color:#e6db74">&#34;</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span> myStream <span style="color:#f92672">&lt;</span><span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">10.0F</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span> myStream <span style="color:#f92672">&lt;</span><span style="color:#f92672">&lt;</span> <span style="color:#66d9ef">int</span>( <span style="color:#ae81ff">42</span> );
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span> std<span style="color:#f92672">:</span><span style="color:#f92672">:</span>string myString;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span> <span style="color:#66d9ef">float</span> myFloat;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span> <span style="color:#66d9ef">int</span> myInt;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span> myStream <span style="color:#f92672">&gt;</span><span style="color:#f92672">&gt;</span> myString;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span> myStream <span style="color:#f92672">&gt;</span><span style="color:#f92672">&gt;</span> myFloat;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span> myStream <span style="color:#f92672">&gt;</span><span style="color:#f92672">&gt;</span> myInt;
</code></pre></div><h2 id="notificao-e-escuta">Notificação e escuta</h2>
<p>Algumas vezes uma aplicação cliente precisa aguardar por algum evento do lado
do servidor para executar algum procedimento.</p>
<p>O PostgreSQL provê o mecanismo LISTEN/NOTIFY, no qual o servidor pode enviar um
sinal para aplicações indicando que um evento ocorreu.</p>
<p>Uma aplicação <code>libpqxx</code> pode ficar dormindo até que um evento seja recebido.
Para dizer a <code>libpqxx</code> que você está interessado em um evento você deve criar um objeto derivado de <code></code>pqxx::trigger`.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-cpp" data-lang="cpp"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">myTrigger</span> <span style="color:#f92672">:</span> <span style="color:#66d9ef">public</span> trigger
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span>{
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span><span style="color:#66d9ef">public</span><span style="color:#f92672">:</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span> <span style="color:#66d9ef">explicit</span> myTrigger( connection <span style="color:#f92672">&amp;</span> conn, string eventName ) <span style="color:#f92672">:</span> trigger( conn, eventName ) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span> }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span> <span style="color:#66d9ef">virtual</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">operator</span>()(<span style="color:#66d9ef">int</span> backendPid ) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span>   cout <span style="color:#f92672">&lt;</span><span style="color:#f92672">&lt;</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Notification: </span><span style="color:#e6db74">&#34;</span> <span style="color:#f92672">&lt;</span><span style="color:#f92672">&lt;</span> name() <span style="color:#f92672">&lt;</span><span style="color:#f92672">&lt;</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74"> received from process </span><span style="color:#e6db74">&#34;</span> <span style="color:#f92672">&lt;</span><span style="color:#f92672">&lt;</span> backendPid <span style="color:#f92672">&lt;</span><span style="color:#f92672">&lt;</span> endl;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span> }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span>};
</code></pre></div><p>O construtor inicia a classe pai com a conexão e o nome do evento. Quando
<code>libpqxx</code> for notificada que o evento ocorreu ela chama a função <code>operator()</code>,
passando o ID do processo no servidor que gerou o evento.</p>
<p>Se você está interessado somente eventos gerados pelo seu processo compare
<code>backendPid</code> com o valor retornado por <code>conn.backendpid()</code>.</p>
<p>The constructor is trivialit simply initializes the parent class with a connection and eventName. When libpqxx is notified that event eventName has occurred, it calls the operator() function, passing it the process ID of the server process that generated the event. If you're only interested in events generated by your server process, compare backendPid with the value returned by conn.backendpid().</p>
<p>Para criar um objeto <code>myTrigger</code> use:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-cpp" data-lang="cpp"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span>connection <span style="color:#a6e22e">conn</span>( argv[<span style="color:#ae81ff">1</span>] );
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span>myTrigger <span style="color:#a6e22e">trigger</span>( conn, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">workOrderReceived</span><span style="color:#e6db74">&#34;</span> );
</code></pre></div><p>Para colocar a aplicação para dormir até que um evento específico ocorra use:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-cpp" data-lang="cpp"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span style="color:#66d9ef">int</span> connection<span style="color:#f92672">:</span><span style="color:#f92672">:</span>await_notification( );
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span><span style="color:#66d9ef">int</span> connection<span style="color:#f92672">:</span><span style="color:#f92672">:</span>await_notification( <span style="color:#66d9ef">long</span> seconds, <span style="color:#66d9ef">long</span> microseconds );
</code></pre></div><p>A segunda forma espera por no máximo o tempo especificado. Ambas as formas retronam o número de notificações (eventos) recebidos.</p>
<h2 id="set-variable-e-get-variable"><code>set_variable()</code> e <code>get_variable()</code></h2>
<p>O servidor PostgreSQL possui um grande número de parâmetros de configuração que afetam sua forma de trabalhar.
As classes <code>connection</code> e <code>transaction&lt;&gt;</code> proveem funções para obter e modificar esta variáveis de configuração:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-cpp" data-lang="cpp"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span style="color:#66d9ef">void</span> connection<span style="color:#f92672">:</span><span style="color:#f92672">:</span>set_variable(std<span style="color:#f92672">:</span><span style="color:#f92672">:</span>string variableName, std<span style="color:#f92672">:</span><span style="color:#f92672">:</span>string newValue);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span><span style="color:#66d9ef">void</span> transaction<span style="color:#f92672">&lt;</span><span style="color:#f92672">&gt;</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span>set_variable(std<span style="color:#f92672">:</span><span style="color:#f92672">:</span>string variableName, std<span style="color:#f92672">:</span><span style="color:#f92672">:</span>string newValue);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3</span>std<span style="color:#f92672">:</span><span style="color:#f92672">:</span>string connection<span style="color:#f92672">:</span><span style="color:#f92672">:</span>get_variable(std<span style="color:#f92672">:</span><span style="color:#f92672">:</span>string variableName);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4</span>std<span style="color:#f92672">:</span><span style="color:#f92672">:</span>string transaction<span style="color:#f92672">&lt;</span><span style="color:#f92672">&gt;</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span>get_variable(std<span style="color:#f92672">:</span><span style="color:#f92672">:</span>string variableName);
</code></pre></div><p>Em cada caso a função lança uma exceção <code>sql_error</code> se <code>variableName</code> não
existir. Uma diferença entre as classes é que uma variável modificada via
<code>transaction&lt;&gt;</code> retorna ao valor original se a transação for abortada.</p>
<h2 id="referncias">Referências</h2>
<ul>
<li><a href="#">The New PostgreSQL C++ APIlibpqxx</a></li>
</ul>

        </div>

        

<div class="share-box center-align" aria-hidden="true">
  <ul class="share">
    <li>
      <a class="facebook"
        href="https://www.facebook.com/sharer.php?u=https%3a%2f%2fgeraldo.dev%2fposts%2ffixme%2fpostgres-pqxx%2f"
        aria-label="share on Facebook"
        target="_blank" rel="noopener">
        <span class="mdi mdi-48px mdi-facebook"></span>
      </a>
    </li>

    <li>
      <a class="twitter"
         href="https://twitter.com/intent/tweet?url=https%3a%2f%2fgeraldo.dev%2fposts%2ffixme%2fpostgres-pqxx%2f&amp;text=Biblioteca%20pqxx"
         target="_blank" rel="noopener">
        <span class="mdi mdi-48px mdi-twitter"></span>
      </a>
    </li>

    <li>
      <a class="linkedin"
         href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fgeraldo.dev%2fposts%2ffixme%2fpostgres-pqxx%2f&amp;title=Biblioteca%20pqxx"
         target="_blank" rel="noopener">
        <span class="mdi mdi-48px mdi-linkedin"></span>
      </a>
    </li>

    <li>
      <a class="email"
         href="mailto:?subject=Biblioteca%20pqxx&amp;body=https%3a%2f%2fgeraldo.dev%2fposts%2ffixme%2fpostgres-pqxx%2f">
        <span class="mdi mdi-48px mdi-email"></span>
      </a>
    </li>

  </ul>
  <span>Compartilhe!</span>
</div>




        <div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "geraldo-dev" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
        <script>
var disqus_config = function () {
  this.language = "pt";
};
</script>

      </div>

    </main>


    
        <footer class="page-footer orange">
  <div class="container">
    <div class="row">
      <div class="col l9 s12">
        <h5 class="white-text">Você tem uma grande ideia?</h5>
        <p class="grey-text text-lighten-4">
          <ul>
            
          </ul>
        </p>

        <p class="grey-text text-lighten-4">
          Vamos marcar um café, talvez a solução seja muito mais simples do que você imagina.
        </p>
      </div>
      <div class="col l3 s12">
        <h5 class="white-text">Contatos</h5>
        <ul>
        
          <li>
            <a class="white-text" href="https://geraldo.dev">
              <span class="mdi mdi-24px mdi-web"></span>
              https://geraldo.dev
            </a>
          </li>
        
          <li>
            <a class="white-text" href="mailto:geraldolsribeiro@gmail.com">
              <span class="mdi mdi-24px mdi-email"></span>
              geraldo@intmain.io
            </a>
          </li>
        
          <li>
            <a class="white-text" href="https://api.whatsapp.com/send?phone=5512982302703&amp;text=Ol%c3%a1%20Geraldo!">
              <span class="mdi mdi-24px mdi-whatsapp"></span>
              (12) 9 8230 2703
            </a>
          </li>
        
          <li>
            <a class="white-text" href="https://twitter.com/geraldo_dev">
              <span class="mdi mdi-24px mdi-twitter"></span>
              geraldo_dev
            </a>
          </li>
        
          <li>
            <a class="white-text" href="https://www.instagram.com/geraldo.dev/">
              <span class="mdi mdi-24px mdi-instagram"></span>
              geraldo.dev
            </a>
          </li>
        
          <li>
            <a class="white-text" href="https://www.linkedin.com/in/geraldolsribeiro/">
              <span class="mdi mdi-24px mdi-linkedin"></span>
              geraldolsribeiro
            </a>
          </li>
        
          <li>
            <a class="white-text" href="https://www.facebook.com/geraldolsribeiro">
              <span class="mdi mdi-24px mdi-facebook"></span>
              geraldolsribeiro
            </a>
          </li>
        
          <li>
            <a class="white-text" href="https://github.com/geraldolsribeiro">
              <span class="mdi mdi-24px mdi-github-circle"></span>
              geraldolsribeiro
            </a>
          </li>
        
          <li>
            <a class="white-text" href="https://t.me/geraldolsribeiro">
              <span class="mdi mdi-24px mdi-telegram"></span>
              geraldolsribeiro
            </a>
          </li>
        
          <li>
            <a class="white-text" href="#ZgotmplZ">
              <span class="mdi mdi-24px mdi-skype"></span>
              geraldolsribeiro
            </a>
          </li>
        
          <li>
            <a class="white-text" href="https://codepen.io/geraldolsribeiro/">
              <span class="mdi mdi-24px mdi-codepen"></span>
              geraldolsribeiro
            </a>
          </li>
        
          <li>
            <a class="white-text" href="https://stackoverflow.com/users/554111/geraldo-luis-da-silva-ribeiro">
              <span class="mdi mdi-24px mdi-stack-overflow"></span>
              Stack overflow
            </a>
          </li>
        
          <li>
            <a class="white-text" href="https://scholar.google.com.br/citations?user=qsuG5ZkAAAAJ">
              <span class="mdi mdi-24px mdi-school"></span>
              Google Scholar
            </a>
          </li>
        
        </ul>
      </div>
    </div>
  </div>

    <div class="fixed-action-btn">
      <a class="btn-floating btn-large waves-effect waves-light ">
        <i class="large material-icons">chat</i>
      </a>
      <ul>
        
        
          <li>
              <a class="btn-floating waves-effect waves-light green darken-4"
                title="Chame pelo whatsapp!"
                target="_blank"
                href="https://api.whatsapp.com/send?phone=5512982302703&amp;text=Ol%c3%a1,%20Geraldo!">
              <span class="mdi mdi-24px mdi-whatsapp"></span>
            </a>
          </li>
        
      </ul>
    </div>


  <div class="footer-copyright">
    <div class="container">
      Feito com <i class="material-icons yellow-text" style="vertical-align: middle;">favorite</i> por Geraldo Ribeiro
    </div>
  </div>
</footer>

    

    
        






<script type="text/javascript" src="https://geraldo.dev/app.min.59882aba5a267177ea44b8e23767eb6092ffbd0fba04434f754edcc58be60ec5.js" integrity="sha256-WYgqulomcXfqRLjiN2frYJL/vQ&#43;6BENPdU7cxYvmDsU=" media="screen"></script>


    
</body>
</html>
