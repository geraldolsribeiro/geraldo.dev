<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="description" content="C++ murmur hash">
    <meta name="author" content="Geraldo Luis da Silva Ribeiro">
    <title>C++ murmur hash</title>
    <script async src="https://ackee.intmain.io/tracker.js" data-ackee-server="https://ackee.intmain.io" data-ackee-domain-id="ae2b54a4-84be-4e13-9143-062488243a8c"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/base16/materia.min.css">
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlightjs-line-numbers.js/2.8.0/highlightjs-line-numbers.min.js"></script>
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6442897272752686" crossorigin="anonymous"></script>
    <meta property="og:image" content="https://geraldo.dev/thumbnail/cpp.webp">
    <meta property="twitter:image" content="https://geraldo.dev/thumbnail/cpp.webp">
    <meta property="thumbnail" content="https://geraldo.dev/thumbnail/cpp.webp">
    <meta property="twitter:card" content="">
    <link rel="stylesheet" href="/styles.css">
  </head>
  <body class="bg-black">
    <nav class="bg-slate-800 text-blue-400 border-gray-200 px-2 sm:px-4 py-2.5">
      <div class="container flex flex-wrap justify-between items-center mx-auto"><a class="flex items-center" href="/"><img class="mr-3 h-6 sm:h-9" src="/logo.svg" alt="Geraldo Ribeiro"><span class="self-center text-xl font-semibold whitespace-nowrap underline-offset-8 hover:underline hover:text-white">Geraldo Ribeiro </span></a>
        <ul class="hidden fixed top-0 right-0 px-10 py-16 bg-gray-800 z-30 md:relative md:flex md:p-0 md:bg-transparent md:flex-row md:space-x-6" id="menu">
          <li class="z-40 fixed top-4 right-6 md:hidden" id="menu-close-btn"><a class="text-right text-blue-500 text-4xl font-bold" href="javascript:void(0)">&times;</a></li>
          <li><a class="block py-2 pr-4 pl-3 text-blue-400 underline-offset-8 hover:text-white hover:underline md:p-0" href="/about.html" aria-current="page">About</a></li>
          <li><a class="block py-2 pr-4 pl-3 text-blue-400 underline-offset-8 hover:text-white hover:underline md:p-0" href="/tils.html" aria-current="page">Today I Learned</a></li>
          <li><a class="block py-2 pr-4 pl-3 text-blue-400 underline-offset-8 hover:text-white hover:underline md:p-0" href="/certificates.html" aria-current="page">Certificates</a></li>
        </ul>
        <div class="flex mr-2 items-center md:hidden" id="menu-hamburger-btn"><a class="text-slate-500 text-2xl font-bold opacity-70 duration-300 hover:opacity-100" href="javascript:void(0)">&#x2630; </a></div>
      </div>
    </nav>
    <script>
      window.addEventListener("load", () => {
        const menuHamburgerBtn = document.querySelector("#menu-hamburger-btn");
        const menuCloseBtn = document.querySelector("#menu-close-btn");
        const menu = document.querySelector("#menu");
        menuHamburgerBtn.addEventListener("click", () => { menu.classList.toggle("hidden"); });
        menuCloseBtn.addEventListener("click", () => { menu.classList.toggle("hidden"); });
      });
    </script>
    <div class="prose mx-auto py-4 px-4">
      <form id="search" method="get" action="/search.html">
        <label class="mb-2 text-sm font-medium text-gray-300 sr-only" for="search-input">Search</label>
        <div class="relative">
          <div class="flex absolute inset-y-0 left-0 items-center pl-3 pointer-events-none">
            <svg class="w-5 h-5 text-gray-500 dark:text-gray-400" aria-hidden="true" fill="none" stroke="currentColor" viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
            </svg>
          </div>
          <input class="block p-4 pl-10 w-full text-sm text-white bg-slate-800 border border-slate-700 placeholder-slate-400 focus:ring-blue-500" id="search-input" type="search" name="query" placeholder="Search vim, bash..." required="">
          <button class="text-white absolute bg-slate-700 font-medium text-sm px-4 py-2 right-2.5 bottom-2.5 hover:bg-blue-800 focus:bg-blue-700 focus:outline-none focus:ring-blue-200" type="submit">Search</button>
        </div>
      </form>
    </div>
    <div class="bg-black text-slate-100 min-h-screen">
      <main class="bg-slate-900 max-w-prose mx-auto prose prose-invert text-slate-400 p-4 overflow-hidden"><a class="mb-2 text-slate-600 block cursor-pointer hover:text-slate-200" href="/tils.html">
          <svg class="inline h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M11 17l-5-5m0 0l5-5m-5 5h12"></path>
          </svg><span>Back to TILs</span></a>
        <h1>C++ murmur hash</h1>
        <div class="text-slate-600">Date: <b class="mr-4 ml-2">2023-03-30</b>Last modified: <b class="ml-2">2024-11-02 </b></div>
        <div class="flex flex-wrap"><a class="tag no-underline" href="/til/tag/C++.html">C++</a><a class="tag no-underline" href="/til/tag/murmurhash.html">murmurhash</a>
        </div>
        <div class="mt-4 mx-auto"><img class="w-full my-0" src="/thumbnail/cpp.webp">
        </div><p><strong>Table of contents</strong></p>
<p><div class="table-of-contents"><ul><li><a href="#introduction">Introduction</a></li><li><a href="#versions">Versions</a></li><li><a href="#debian-package">Debian package</a></li><li><a href="#possible-output">Possible output</a></li><li><a href="#references">References</a></li></ul></div></p>
<h2 id="introduction" tabindex="-1">Introduction</h2>
<p>The name comes from two basic operations, <strong>MU</strong>ltiply and <strong>R</strong>otate.</p>
<p><strong>MurmurHash3</strong> is a <strong>non-cryptographic hash function</strong> that produces a
32-bit hash value for a given input data. It was designed to be
fast and produce good quality hash values for a wide variety of
input data.</p>
<p>The basic MurmurHash3 algorithm works as follows:</p>
<ul>
<li>Initialize a 32-bit hash value to a seed value (usually 0).</li>
<li>Process the input data in 4-byte blocks.
<ul>
<li>For each block, perform a series of operations that mix the
bits of the block into the hash value.</li>
</ul>
</li>
<li>Process any remaining bytes (i.e., the “tail” of the input data).
<ul>
<li>Combine the remaining bytes with the hash value using a different
mixing function.</li>
</ul>
</li>
<li>Finalize the hash value by performing a series of operations that
further mix the bits of the hash value.
<ul>
<li>This step is optional, but it can improve the quality of the
hash value.</li>
</ul>
</li>
</ul>
<p>The MurmurHash3 algorithm uses a combination of multiplication,
XOR, bit shifting, and other bitwise operations to mix the bits
of the input data and produce the final hash value. The specific
operations used are designed to avoid “avalanche” effects (i.e.,
small changes in the input data should produce large changes in
the hash value) and to be efficient on modern processors.</p>
<p>The constants <code>c1</code>, <code>c2</code>, <code>rotation_1</code>, <code>rotation_2</code>, <code>m</code>, and
<code>n</code> used in the algorithm are carefully chosen to produce good
quality hash values. These constants are not secret, and can be
freely shared.</p>
<p>Note that the MurmurHash3 algorithm is designed to be used with
byte-oriented data, but it can be used with other data types by first
converting them to byte arrays. Also note that while MurmurHash3 is
a good general-purpose hash function, there are other hash functions
that may be better suited for specific applications or data types.</p>
<h2 id="versions" tabindex="-1">Versions</h2>
<h3 id="murmurhash1" tabindex="-1">MurmurHash1</h3>
<p>The original MurmurHash was created as an attempt to make a faster
function than Lookup3. Although successful, it hadn’t been
tested thoroughly and wasn’t capable of providing 64-bit hashes
as in Lookup3. It had a rather elegant design, that would be later
built upon in MurmurHash2, combining a multiplicative hash (similar
to Fowler–Noll–Vo hash function) with a Xorshift.</p>
<h3 id="murmurhash2" tabindex="-1">MurmurHash2</h3>
<p>MurmurHash2 yields a 32-bit or 64-bit value. It came in multiple
variants, including some that allowed incremental hashing and
aligned or neutral versions.</p>
<ul>
<li>MurmurHash2 (32-bit, x86)
<ul>
<li>The original version; contains a flaw that weakens collision in some</li>
</ul>
</li>
<li>MurmurHash2A (32-bit, x86)
<ul>
<li>A fixed variant using Merkle–Damgård construction. Slightly slower.</li>
</ul>
</li>
<li>CMurmurHash2A (32-bit, x86)
<ul>
<li>MurmurHash2A but works incrementally.</li>
</ul>
</li>
<li>MurmurHashNeutral2 (32-bit, x86)
<ul>
<li>Slower, but endian and alignment neutral.</li>
</ul>
</li>
<li>MurmurHashAligned2 (32-bit, x86)
<ul>
<li>Slower, but does aligned reads (safer on some platforms).</li>
</ul>
</li>
<li>MurmurHash64A (64-bit, x64)
<ul>
<li>The original 64-bit version. Optimized for 64-bit arithmetic.</li>
</ul>
</li>
<li>MurmurHash64B (64-bit, x86)
<ul>
<li>A 64-bit version optimized for 32-bit platforms. It is not a
true 64-bit hash due to insufficient mixing of the stripes.</li>
</ul>
</li>
</ul>
<p>The person who originally found the flaw[clarification needed] in
MurmurHash2 created an unofficial 160-bit version of MurmurHash2
called MurmurHash2_160.</p>
<h3 id="murmurhash3" tabindex="-1">MurmurHash3</h3>
<p>The current version is MurmurHash3, which yields a <strong>32-bit</strong> or
<strong>128-bit</strong> hash value.</p>
<div role="alert" class="my-4">
  <div class="bg-yellow-200 text-black font-bold rounded-t px-4 py-2">
    <span class="text-2xl">☢</span>
    <span>Warning</span>
  </div>
  <div class="border border-t-0 border-yellow-200 rounded-b px-4 py-3">
<p>When using 128-bits, the x86 and x64 versions do not produce the
same values, as the algorithms are optimized for their respective
platforms.</p>
  </div>
</div>
<p>MurmurHash3 was released alongside SMHasher—a hash function
test suite.</p>
<h2 id="debian-package" tabindex="-1">Debian package</h2>
<p>There is a package called <code>libmurmurhash-dev</code> in the standard Debian
distro.</p>
<pre><code class="language-shell">sudo apt install libmurmurhash-dev
</code></pre>
<p>Use the version at
<a href="https://github.com/aappleby/smhasher/blob/master/src/MurmurHash3.cpp">https://github.com/aappleby/smhasher/blob/master/src/MurmurHash3.cpp</a>
for production.</p>
<p>Below is presented a 32 bits version for explain the process.</p>
<pre><code class="language-cpp">// MurmurHash3 constants
constexpr uint32_t c1 = 0xcc9e2d51;
constexpr uint32_t c2 = 0x1b873593;
constexpr uint32_t rotation_1 = 15;
constexpr uint32_t rotation_2 = 13;
constexpr uint32_t m = 5;
constexpr uint32_t n = 0xe6546b64;
</code></pre>
<pre><code class="language-cpp">// This function performs the core MurmurHash3 algorithm
uint32_t murmurhash3_core(const uint8_t* data, size_t len, uint32_t h) {
  const uint32_t* blocks = reinterpret_cast&lt;const uint32_t*&gt;(data);
  const size_t n_blocks = len / sizeof(uint32_t);  // four bytes block

  for (size_t i = 0; i &lt; n_blocks; ++i) {
    uint32_t block = blocks[i];

    block *= c1;
    // block rotation 1
    block = (block &lt;&lt; rotation_1) | (block &gt;&gt; (32 - rotation_1));
    // 01011001110001111000011111000000 original block
    // --------------------------------
    // 11000011111000000000000000000000 block &lt;&lt; 15
    // 00000000000000001011001110001111 block &gt;&gt; (32-15)
    // -------------------------------- or
    // 11000011111000001011001110001111 rotated block

    block *= c2;

    h ^= block;

    // block rotation 2
    h = (h &lt;&lt; rotation_2) | (h &gt;&gt; (32 - rotation_2));
    h = h * m + n;
  }

  const uint8_t* tail = data + n_blocks * sizeof(uint32_t);
  uint32_t block = 0;

  switch (len &amp; 3) {
    case 3:
      block ^= tail[2] &lt;&lt; 16;
      [[fallthrough]];
    case 2:
      block ^= tail[1] &lt;&lt; 8;
      [[fallthrough]];
    case 1:
      block ^= tail[0];
      block *= c1;
      block = (block &lt;&lt; rotation_1) | (block &gt;&gt; (32 - rotation_1));
      block *= c2;
      h ^= block;
  }

  h ^= len;
  h ^= h &gt;&gt; 16;
  h *= 0x85ebca6b;
  h ^= h &gt;&gt; 13;
  h *= 0xc2b2ae35;
  h ^= h &gt;&gt; 16;

  return h;
}
</code></pre>
<pre><code class="language-cpp">// This is the main MurmurHash3 function that clients will use
uint32_t murmurhash3(const void* key, size_t len, uint32_t seed = 0) {
  const uint8_t* data = reinterpret_cast&lt;const uint8_t*&gt;(key);
  const size_t n_blocks = len / sizeof(uint32_t);

  uint32_t h = seed;

  // Process the data in 4-byte blocks
  h = murmurhash3_core(data, n_blocks * sizeof(uint32_t), h);

  // Process any remaining bytes
  const size_t n_tail = len % sizeof(uint32_t);
  if (n_tail != 0) {
    uint32_t k = 0;
    memcpy(&amp;k, data + n_blocks * sizeof(uint32_t), n_tail);
    h ^= k;
    h *= c1;
    h = (h &lt;&lt; rotation_1) | (h &gt;&gt; (32 - rotation_1));
    h *= c2;
  }

  // Finalize the hash
  h ^= len;
  h ^= h &gt;&gt; 16;
  h *= 0x85ebca6b;
  h ^= h &gt;&gt; 13;
  h *= 0xc2b2ae35;
  h ^= h &gt;&gt; 16;

  return h;
}
</code></pre>
<pre><code class="language-cpp">int main() {
  // Avalanche test on seed
  // Small change on key result on dramatically change on computed hash
  constexpr uint32_t seed1 = 1234;
  constexpr uint32_t seed2 = 1235;

  // Avalanche test on input
  // Small change on input result on dramatically change on computed hash
  std::list&lt;std::string&gt; texts{&quot;Hello, world!&quot;,
                               &quot;hello, world!&quot;,
                               &quot;Hello, World!&quot;,
                               &quot;hello, world!&quot;,
                               &quot;&quot;,
                               &quot;h&quot;,
                               &quot;he&quot;,
                               &quot;hello&quot;};

  for (const auto&amp; text : texts) {
    uint32_t hash1 = murmurhash3(text.data(), text.size(), seed1);
    uint32_t hash2 = murmurhash3(text.data(), text.size(), seed2);

    fmt::print(&quot;hash: {:10}   seed: {}   text: {}\n&quot;, hash1, seed1, text);
    fmt::print(&quot;hash: {:10}   seed: {}   text: {}\n&quot;, hash2, seed2, text);
  }

  // Tests with the package libmurmurhash-dev
  // clang-format off
  // void lmmh_x86_32( const void *addr, unsigned int len, uint32_t seed, uint32_t out[1]);
  // void lmmh_x86_128(const void *addr, unsigned int len, uint32_t seed, uint32_t out[4]);
  // void lmmh_x64_128(const void *addr, unsigned int len, uint32_t seed, uint64_t out[2]);
  // clang-format on
  for (const auto&amp; text : texts) {
    uint32_t hash32;
    lmmh_x86_32(text.data(), text.size(), seed1, &amp;hash32);
    fmt::print(&quot;hash: {:10}   seed: {}   text: {}\n&quot;, hash32, seed1, text);
  }

  for (const auto&amp; text : texts) {
    uint32_t hash128A[4];
    uint64_t hash128B[2];

    lmmh_x86_128(text.data(), text.size(), seed1, hash128A);
    lmmh_x64_128(text.data(), text.size(), seed1, hash128B);

    fmt::print(&quot;hash128A: {:10} {:10} {:10} {:10}   seed: {}   text: {}\n&quot;,
               hash128A[0], hash128A[1], hash128A[2], hash128A[3], seed1, text);

    fmt::print(&quot;hash128B: {:21} {:21}   seed: {}   text: {}\n&quot;, hash128B[0],
               hash128B[1], seed1, text);
  }

  return 0;
}

</code></pre>
<h2 id="possible-output" tabindex="-1">Possible output</h2>
<pre><code class="language-txt">hash: 1880165001   seed: 1234   text: Hello, world!
hash:   37900214   seed: 1235   text: Hello, world!
hash: 1773352101   seed: 1234   text: hello, world!
hash: 3125240818   seed: 1235   text: hello, world!
hash: 2650466895   seed: 1234   text: Hello, World!
hash: 3693886096   seed: 1235   text: Hello, World!
hash: 1773352101   seed: 1234   text: hello, world!
hash: 3125240818   seed: 1235   text: hello, world!
hash: 3613156711   seed: 1234   text: 
hash: 2319787446   seed: 1235   text: 
hash: 1968416228   seed: 1234   text: h
hash: 3135554948   seed: 1235   text: h
hash: 1299136751   seed: 1234   text: he
hash: 3700568032   seed: 1235   text: he
hash:  616337965   seed: 1234   text: hello
hash: 3371755843   seed: 1235   text: hello
hash: 4210478515   seed: 1234   text: Hello, world!
hash: 1215213111   seed: 1234   text: hello, world!
hash: 3644279836   seed: 1234   text: Hello, World!
hash: 1215213111   seed: 1234   text: hello, world!
hash:  254590987   seed: 1234   text: 
hash: 1073392072   seed: 1234   text: h
hash:   19595036   seed: 1234   text: he
hash: 2251423591   seed: 1234   text: hello
hash128A: 4192683273 3344351611  905885657  131714559   seed: 1234   text: Hello, world!
hash128B:   6994950471748863742   5906757252613544790   seed: 1234   text: Hello, world!
hash128A: 3379794421 1391467063  204088760 2201735466   seed: 1234   text: hello, world!
hash128B:   3334729735983292266  15246033631058457288   seed: 1234   text: hello, world!
hash128A: 2645690248 1320752661 2676918588 3486440893   seed: 1234   text: Hello, World!
hash128B:  13342170012096846388  10422801084110055398   seed: 1234   text: Hello, World!
hash128A: 3379794421 1391467063  204088760 2201735466   seed: 1234   text: hello, world!
hash128B:   3334729735983292266  15246033631058457288   seed: 1234   text: hello, world!
hash128A:  396337949 2466738178 2466738178 2466738178   seed: 1234   text: 
hash128B:   5006475794136178589  13573877494810213620   seed: 1234   text: 
hash128A: 3741828134 1966168643 1966168643 1966168643   seed: 1234   text: h
hash128B:  11851864647889073320  18017523628106187849   seed: 1234   text: h
hash128A:  740872880 1097768591 1097768591 1097768591   seed: 1234   text: he
hash128B:  12027140842659985391   5619874163494401635   seed: 1234   text: he
hash128A: 1597004003 2034712666 2930991220 2930991220   seed: 1234   text: hello
hash128B:  10403193130508565092  11308957242644105945   seed: 1234   text: hello

</code></pre>
<h2 id="references" tabindex="-1">References</h2>
<ul>
<li>▶️<a href="https://www.youtube.com/watch?v=b8HzEZt0RCQ">Murmur Hash - Explained</a></li>
<li><a href="https://blog.teamleadnet.com/2012/08/murmurhash3-ultra-fast-hash-algorithm.html">MurMurHash3, an ultra fast hash algorithm for C# / .NET</a></li>
<li><a href="https://github.com/aappleby/smhasher/blob/master/src/MurmurHash3.cpp">MurmurHash3 on Github</a></li>
</ul>

      </main>
    </div>
    <footer class="bg-slate-500 text-slate-400 text-center pb-16">
      <div class="py-4 bg-slate-800">&copy; Geraldo Ribeiro 2024</div>
      <div class="max-w-prose mx-auto py-4 grid gap-y-8 grid-cols-3 justify-items-center md:grid-cols-5 lg:grid-cols-12"><a class="mx-2" href="mailto:geraldolsribeiro@gmail.com" target="_blank"><img class="h-12 w-12" title="E-mail" alt="E-mail" src="/social-email.svg"></a><a class="mx-2" href="https://www.linkedin.com/in/geraldolsribeiro/" target="_blank"><img class="h-12 w-12" title="Linkedin" alt="Linkedin" src="/social-linkedin.svg"></a><a class="mx-2" href="https://github.com/geraldolsribeiro" target="_blank"><img class="h-12 w-12" title="Github" alt="Github" src="/social-github.svg"></a><a class="mx-2" href="https://codepen.io/geraldolsribeiro/" target="_blank"><img class="h-12 w-12" title="Codepen" alt="Codepen" src="/social-codepen.svg"></a><a class="mx-2" href="https://twitter.com/geraldo_dev" target="_blank"><img class="h-12 w-12" title="Twitter" alt="Twitter" src="/social-twitter.svg"></a><a class="mx-2" href="https://t.me/geraldolsribeiro" target="_blank"><img class="h-12 w-12" title="Telegram" alt="Telegram" src="/social-telegram.svg"></a><a class="mx-2" href="https://api.whatsapp.com/send?phone=5512982302703&amp;text=Hi%20Geraldo!" target="_blank"><img class="h-12 w-12" title="Whatsapp" alt="Whatsapp" src="/social-whatsapp.svg"></a><a class="mx-2" href="https://www.instagram.com/geraldo.dev/" target="_blank"><img class="h-12 w-12" title="Instagram" alt="Instagram" src="/social-instagram.svg"></a><a class="mx-2" href="https://www.facebook.com/geraldolsribeiro" target="_blank"><img class="h-12 w-12" title="Facebook" alt="Facebook" src="/social-facebook.svg"></a><a class="mx-2" href="https://stackoverflow.com/users/554111/geraldo-luis-da-silva-ribeiro" target="_blank"><img class="h-12 w-12" title="StackOverflow" alt="StackOverflow" src="/social-stackoverflow.svg"></a><a class="mx-2" href="https://www.youtube.com/@dev.geraldo" target="_blank"><img class="h-12 w-12" title="Youtube" alt="Youtube" src="/social-youtube.svg"></a>
      </div>
    </footer>
    <script>
      //- hljs.highlightAll();
      //- https://github.com/wcoder/highlightjs-line-numbers.js
      //- Exemplo de numeracao em corba.md
      document.addEventListener('DOMContentLoaded', (event) => {
        document.querySelectorAll('pre code').forEach((el) => {
          hljs.highlightElement(el);
        });
      
        document.querySelectorAll('pre code[show-line-numbers]').forEach((el) => {
          hljs.lineNumbersBlock(el); // numbering using plugin
        });
      
      });
    </script>
    <script src="https://utteranc.es/client.js" repo="geraldolsribeiro/geraldo.dev" issue-term="pathname" theme="github-dark" crossorigin="anonymous" async></script>
  </body>
</html>