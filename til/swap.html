<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="description" content="Description not defined">
    <title>Gerenciamento de memória swap</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.6.0/styles/monokai.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.6.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.6.0/languages/cpp.min.js"></script>
    <link rel="stylesheet" href="/styles.css">
  </head>
  <body>
    <nav class="bg-slate-800 text-blue-400 border-gray-200 px-2 sm:px-4 py-2.5">
      <div class="container flex flex-wrap justify-between items-center mx-auto"><a class="flex items-center" href="/"><img class="mr-3 h-6 sm:h-9" src="/logo.svg" alt="Geraldo Ribeiro"><span class="self-center text-xl font-semibold whitespace-nowrap underline-offset-8 hover:underline hover:text-white"> Geraldo Ribeiro </span></a>
        <ul class="hidden fixed top-0 right-0 px-10 py-16 bg-gray-800 z-30 md:relative md:flex md:p-0 md:bg-transparent md:flex-row md:space-x-6">
          <li class="z-40 fixed top-4 right-6 md:hidden"><a class="text-right text-blue-500 text-4xl font-bold" href="javascript:void(0)">&times;</a></li>
          <li><a class="block py-2 pr-4 pl-3 text-blue-400 underline-offset-8 hover:text-white hover:underline md:p-0" href="/about.html" aria-current="page">About</a></li>
          <li><a class="block py-2 pr-4 pl-3 text-blue-400 underline-offset-8 hover:text-white hover:underline md:p-0" href="/tils.html" aria-current="page">Today I Learned</a></li>
          <li><a class="block py-2 pr-4 pl-3 text-blue-400 underline-offset-8 hover:text-white hover:underline md:p-0" href="/projects.html" aria-current="page">Projects</a></li>
          <li><a class="block py-2 pr-4 pl-3 text-blue-400 underline-offset-8 hover:text-white hover:underline md:p-0" href="/papers.html" aria-current="page">Papers</a></li>
          <li><a class="block py-2 pr-4 pl-3 text-blue-400 underline-offset-8 hover:text-white hover:underline md:p-0" href="/certificates.html" aria-current="page">Certificates</a></li>
        </ul>
        <div class="flex mr-2 items-center md:hidden"><a class="text-slate-500 text-2xl font-bold opacity-70 duration-300 hover:opacity-100" href="javascript:void(0)"> &#x2630; </a></div>
      </div>
    </nav>
    <div class="bg-black text-slate-100 min-h-screen">
      <main class="bg-slate-900 max-w-prose mx-auto prose prose-invert text-slate-400 p-4"><a class="text-slate-400 block cursor-pointer hover:text-slate-200" href="/tils.html">
          <svg class="inline h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M11 17l-5-5m0 0l5-5m-5 5h12"></path>
          </svg><span>Back to TILs</span></a>
        <h1>Gerenciamento de memória swap</h1>
        <div class="flex flex-wrap"><a class="tag" href="/til/tag/swap.html">swap</a><a class="tag" href="/til/tag/debian.html">debian</a><a class="tag" href="/til/tag/linux.html">linux</a>
        </div><h2 id="configura%C3%A7%C3%A3o-atual" tabindex="-1">Configuração atual</h2>
<pre><code class="language-bash">swapon --show
</code></pre>
<p>A saída do comando acima, se tiver swap configurado, será parecido com:</p>
<pre><code class="language-bash">NAME      TYPE      SIZE USED PRIO
/dev/sda5 partition 2,9G   1G   -2
</code></pre>
<p>Neste caso uma partição foi utilizada para swap.</p>
<p>Outro modo de verificar o swap é:</p>
<pre><code class="language-bash">free -h
</code></pre>
<p>Na ausência o valor é informado como zero.</p>
<pre><code class="language-bash">Mem:          996Mi       262Mi        79Mi        40Mi       654Mi       514Mi
Swap:            0B          0B          0B
</code></pre>
<h2 id="verificar-se-existe-espa%C3%A7o-dispon%C3%ADvel-para-cria%C3%A7%C3%A3o" tabindex="-1">Verificar se existe espaço disponível para criação</h2>
<p>Antes de criar o swap é necessário garantir que existe espaço em disco.</p>
<pre><code class="language-bash">$ df -ah
</code></pre>
<p>Saída</p>
<pre><code>Filesystem      Size  Used Avail Use% Mounted on
sysfs              0     0     0    - /sys
proc               0     0     0    - /proc
udev            488M     0  488M   0% /dev
devpts             0     0     0    - /dev/pts
tmpfs           100M   13M   88M  13% /run
/dev/vda1        25G   11G   14G  45% /
securityfs         0     0     0    - /sys/kernel/security
tmpfs           499M   12K  499M   1% /dev/shm
tmpfs           5.0M     0  5.0M   0% /run/lock
tmpfs           499M     0  499M   0% /sys/fs/cgroup
</code></pre>
<h2 id="cria%C3%A7%C3%A3o-do-arquivo-de-swap" tabindex="-1">Criação do arquivo de swap</h2>
<p>Como a memória do sistema é de 1GB vamos criar um arquivo de swap com 2GB no raiz.</p>
<pre><code class="language-bash">fallocate -l 2G /swapfile
</code></pre>
<p>O acesso deve ser somente do root:</p>
<pre><code class="language-bash">chown root.root /swapfile
chmod 600 /swapfile
ls -lh /swapfile
</code></pre>
<p>Saída</p>
<pre><code>-rw------- 1 root root 2.0G Aug 10 09:45 /swapfile
</code></pre>
<p>Com as permissões corretas podemos continuar marcando o espaço como swap:</p>
<pre><code class="language-bash">mkswap /swapfile
</code></pre>
<pre><code>Setting up swapspace version 1, size = 2 GiB (2147479552 bytes)
no label, UUID=xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx
</code></pre>
<h2 id="ativando-o-swap" tabindex="-1">Ativando o swap</h2>
<p>Depois de marcado podemos disponibilizar o swap para o sistema.</p>
<pre><code class="language-bash">swapon /swapfile
</code></pre>
<pre><code>NAME      TYPE SIZE USED PRIO
/swapfile file   2G   0B   -1
</code></pre>
<p>Vamos verificar como os comando que já vimos anteriormente:</p>
<pre><code class="language-bash">$ swapon --show
NAME      TYPE SIZE USED PRIO
/swapfile file   2G   0B   -1

$ free -h
              total        used        free      shared  buff/cache   available
Mem:          996Mi       263Mi        74Mi        40Mi       658Mi       513Mi
Swap:         2.0Gi          0B       2.0Gi
</code></pre>
<h2 id="tornando-o-swap-permanente" tabindex="-1">Tornando o swap permanente</h2>
<p>Primeiramente faremos um backup do arquivo fstab</p>
<pre><code class="language-bash">cp /etc/fstab /etc/fstab.bak
</code></pre>
<p>Agora vamos acrescentar uma linha no final do fstab</p>
<pre><code class="language-bash">echo '/swapfile none swap sw 0 0' | tee -a /etc/fstab
</code></pre>
<h2 id="ajustes-finos" tabindex="-1">Ajustes finos</h2>
<h3 id="swappiness" tabindex="-1">Swappiness</h3>
<p>Este parâmetro, que varia de 0 a 100, ajusta a frequência de acesso ao swap</p>
<ul>
<li>próximos a 0: o sistema só acessa o swap se absolutamente necessário (mais rápido)</li>
<li>próximos a 100: prioriza colocar os dados no swap para liberar RAM</li>
<li>desktop: 60</li>
<li>server: 10</li>
</ul>
<p>Para verificar a configuração atual use:</p>
<pre><code class="language-bash">cat /proc/sys/vm/swappiness
</code></pre>
<p>Para definir o valor 10 use:</p>
<pre><code class="language-bash">sysctl vm.swappiness=10
</code></pre>
<p>Para deixar permanente a configuração:</p>
<pre><code class="language-bash">cp /etc/sysctl.conf /etc/sysctl.conf.bak
echo 'vm.swappiness=10' | tee -a /etc/sysctl.conf
</code></pre>
<h3 id="cache-pressure" tabindex="-1">Cache pressure</h3>
<p>Usado para realizar cache de informações de <code>inode</code> e <code>dentry</code> possibilitando reduzir o custo de acessar esta informações frequentemente.</p>
<p>Para verificar o valor atual use:</p>
<pre><code class="language-bash">cat /proc/sys/vm/vfs_cache_pressure
</code></pre>
<p>Saída</p>
<pre><code>100
</code></pre>
<p>Da maneira como está agora o sistema removerá as informações sobre <code>inode</code> muito rapidamente.
Vamos adotar uma configuração mais conservativa utilizando o valor 50.</p>
<pre><code class="language-bash">sysctl vm.vfs_cache_pressure=50
</code></pre>
<p>Para deixar permanente a configuração</p>
<pre><code class="language-bash">echo 'vm.vfs_cache_pressure=50' | tee -a /etc/sysctl.conf
</code></pre>
<h2 id="refer%C3%AAncias" tabindex="-1">Referências</h2>
<ul>
<li><a href="https://www.digitalocean.com/community/tutorials/how-to-add-swap-space-on-ubuntu-16-04">How To Add Swap Space on Ubuntu 16.04</a></li>
</ul>

      </main>
    </div>
    <footer class="bg-slate-500 text-slate-400 text-center pb-16">
      <div class="py-4 bg-slate-800">&copy; Geraldo Ribeiro 2022</div>
      <div class="max-w-prose mx-auto py-4 grid gap-y-8 grid-cols-3 justify-items-center md:grid-cols-5 lg:grid-cols-10"><a class="mx-2" href="mailto:geraldolsribeiro@gmail.com" target="_blank"><img class="h-12 w-12" title="E-mail" alt="E-mail" src="/social-email.svg"></a><a class="mx-2" href="https://www.linkedin.com/in/geraldolsribeiro/" target="_blank"><img class="h-12 w-12" title="Linkedin" alt="Linkedin" src="/social-linkedin.svg"></a><a class="mx-2" href="https://github.com/geraldolsribeiro" target="_blank"><img class="h-12 w-12" title="Github" alt="Github" src="/social-github.svg"></a><a class="mx-2" href="https://codepen.io/geraldolsribeiro/" target="_blank"><img class="h-12 w-12" title="Codepen" alt="Codepen" src="/social-codepen.svg"></a><a class="mx-2" href="https://twitter.com/geraldo_dev" target="_blank"><img class="h-12 w-12" title="Twitter" alt="Twitter" src="/social-twitter.svg"></a><a class="mx-2" href="https://t.me/geraldolsribeiro" target="_blank"><img class="h-12 w-12" title="Telegram" alt="Telegram" src="/social-telegram.svg"></a><a class="mx-2" href="https://api.whatsapp.com/send?phone=5512982302703&amp;text=Hi%20Geraldo!" target="_blank"><img class="h-12 w-12" title="Whatsapp" alt="Whatsapp" src="/social-whatsapp.svg"></a><a class="mx-2" href="https://www.instagram.com/geraldo.dev/" target="_blank"><img class="h-12 w-12" title="Instagram" alt="Instagram" src="/social-instagram.svg"></a><a class="mx-2" href="https://www.facebook.com/geraldolsribeiro" target="_blank"><img class="h-12 w-12" title="Facebook" alt="Facebook" src="/social-facebook.svg"></a><a class="mx-2" href="https://stackoverflow.com/users/554111/geraldo-luis-da-silva-ribeiro" target="_blank"><img class="h-12 w-12" title="StackOverflow" alt="StackOverflow" src="/social-stackoverflow.svg"></a>
      </div>
    </footer>
    <script>
      //- hljs.highlightAll();
      document.addEventListener('DOMContentLoaded', (event) => {
        document.querySelectorAll('pre code').forEach((el) => {
          hljs.highlightElement(el);
        });
      });
    </script>
  </body>
</html>